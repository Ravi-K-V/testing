<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EyeSpecialist.ai - Advanced Clinical Decision Support</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #FAFAFA;
            min-height: 100vh;
        }

        .header {
            background-color: #0A3D62;
            color: white;
            padding: 1.5rem;
        }

        .header-content {
            max-width: 64rem;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .header-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 0;
        }

        .header-subtitle {
            color: #bfdbfe;
            margin: 0;
            font-size: 0.875rem;
        }

        .assessment-header .header-title {
            font-size: 1.25rem;
        }

        .back-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #bfdbfe;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 0.875rem;
            padding: 0.5rem;
            border-radius: 0.25rem;
            transition: background-color 0.2s;
        }

        .back-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .main-content {
            max-width: 64rem;
            margin: 0 auto;
            padding: 1.5rem;
        }

        .card {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
            padding: 2rem;
            margin-bottom: 1.5rem;
        }

        .welcome-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: #1C1C1C;
        }

        .welcome-description {
            color: #6b7280;
            margin-bottom: 1.5rem;
        }

        .disclaimer {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 2rem;
            padding: 0.75rem;
            background-color: #fef3c7;
            border-radius: 0.25rem;
            border-left: 4px solid #f59e0b;
        }

        .condition-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }

        .condition-card {
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }

        .condition-card:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .condition-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .condition-title {
            font-weight: 600;
            font-size: 1.125rem;
            color: #1C1C1C;
            margin: 0;
        }

        .condition-description {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.75rem;
        }

        .condition-pathways {
            font-size: 0.75rem;
            color: #6b7280;
        }

        .progress-container {
            background: white;
            border-bottom: 1px solid #e5e7eb;
        }

        .progress-content {
            max-width: 64rem;
            margin: 0 auto;
            padding: 1rem;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        .progress-bar {
            width: 100%;
            background-color: #e5e7eb;
            border-radius: 9999px;
            height: 0.5rem;
        }

        .progress-fill {
            height: 0.5rem;
            border-radius: 9999px;
            transition: width 0.3s;
            background-color: #0A3D62;
        }

        .question-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: #1C1C1C;
        }

        .question-subtitle {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 1rem;
            font-style: italic;
        }

        .options-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .option-button {
            width: 100%;
            padding: 1rem;
            text-align: left;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
        }

        .option-button:hover {
            background-color: #eff6ff;
            border-color: #3b82f6;
        }

        .yes-no-container {
            display: flex;
            gap: 1rem;
        }

        .yes-button, .no-button {
            flex: 1;
            padding: 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            font-weight: 500;
        }

        .yes-button:hover {
            background-color: #f0fdf4;
            border-color: #22c55e;
        }

        .no-button:hover {
            background-color: #fef2f2;
            border-color: #ef4444;
        }

        .red-flags-box {
            background-color: #fef2f2;
            border: 1px solid #fca5a5;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .red-flags-title {
            font-weight: 600;
            color: #dc2626;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .red-flags-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .red-flag-item {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            color: #7f1d1d;
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
        }

        .clinical-note {
            background-color: #eff6ff;
            border-left: 4px solid #0A3D62;
            padding: 1rem;
            margin-top: 1rem;
            font-size: 0.875rem;
            color: #374151;
        }

        .assessment-summary {
            margin-top: 2rem;
            padding: 1rem;
            background-color: #f9fafb;
            border-radius: 0.5rem;
        }

        .summary-title {
            font-weight: 500;
            font-size: 0.875rem;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .summary-items {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
        }

        .summary-value {
            font-weight: 500;
        }

        .recommendation-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .urgency-icon {
            padding: 0.5rem;
            border-radius: 50%;
            color: white;
        }

        .recommendation-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1C1C1C;
            margin: 0;
        }

        .recommendation-subtitle {
            color: #6b7280;
            margin: 0;
        }

        .reasoning-box {
            background-color: #f9fafb;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .reasoning-text {
            color: #374151;
            margin: 0;
        }

        .section-title {
            font-weight: 600;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #1C1C1C;
        }

        .next-steps-box {
            background-color: #eff6ff;
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 4px solid #0A3D62;
        }

        .next-steps-text {
            color: #374151;
            margin: 0;
        }

        .forms-list, .safety-list, .management-list {
            margin: 0;
            padding: 0;
            list-style: none;
        }

        .forms-item, .safety-item, .management-item {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .secondary-button {
            flex: 1;
            background: white;
            border: 1px solid #d1d5db;
            color: #374151;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .secondary-button:hover {
            background-color: #f9fafb;
        }

        .primary-button {
            flex: 1;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            border: none;
            background-color: #0A3D62;
            transition: opacity 0.2s;
        }

        .primary-button:hover {
            opacity: 0.9;
        }

        .copy-button {
            flex: 1;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            border: none;
            background-color: #059669;
            transition: opacity 0.2s;
        }

        .copy-button:hover {
            opacity: 0.9;
        }

        .copy-success {
            background-color: #10b981 !important;
        }

        .hidden {
            display: none !important;
        }

        .icon {
            width: 20px;
            height: 20px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
        }

        .eye-icon {
            width: 32px;
            height: 32px;
        }

        .section-margin {
            margin-bottom: 1.5rem;
        }

        .management-box {
            background-color: #f0fdf4;
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 4px solid #22c55e;
            margin-bottom: 1rem;
        }

        .management-title {
            font-weight: 600;
            color: #166534;
            margin-bottom: 0.5rem;
        }

        .pathway-indicator {
            font-size: 0.75rem;
            color: #6b7280;
            background-color: #f3f4f6;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            margin-bottom: 0.5rem;
            display: inline-block;
        }

        .severity-indicator {
            margin-top: 1rem;
            padding: 0.75rem;
            background-color: #f3f4f6;
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }

        .severity-score {
            font-weight: 600;
            color: #1C1C1C;
            margin-bottom: 0.25rem;
        }

        .severity-bar {
            width: 100%;
            height: 0.5rem;
            background-color: #e5e7eb;
            border-radius: 0.25rem;
            margin-top: 0.5rem;
            position: relative;
            overflow: hidden;
        }

        .severity-fill {
            height: 100%;
            border-radius: 0.25rem;
            transition: width 0.5s ease;
            background: linear-gradient(to right, #22c55e, #FFC300, #dc3545);
        }

        /* GOS18 Form Styles */
        .gos18-container {
            margin-top: 2rem;
            padding: 1rem;
            background: white;
            border: 2px solid #0A3D62;
            border-radius: 0.5rem;
            position: relative;
            max-width: 100%;
            overflow-x: auto;
        }

        @media (min-width: 768px) {
            .gos18-container {
                padding: 2rem;
            }
        }

        .gos18-header {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #0A3D62;
        }

        @media (min-width: 768px) {
            .gos18-header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }

        .gos18-title {
            font-size: 1.25rem;
            font-weight: bold;
            color: #0A3D62;
        }

        @media (min-width: 768px) {
            .gos18-title {
                font-size: 1.5rem;
            }
        }

        .gos18-subtitle {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        @media (min-width: 768px) {
            .gos18-subtitle {
                font-size: 0.875rem;
            }
        }

        .gos18-close {
            background: #dc2626;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background-color 0.2s;
            align-self: flex-start;
        }

        .gos18-close:hover {
            background-color: #b91c1c;
        }

        .gos18-form {
            font-size: 0.75rem;
            font-family: 'Arial', sans-serif;
        }

        @media (min-width: 768px) {
            .gos18-form {
                font-size: 0.875rem;
            }
        }

        .gos18-form table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
            background: white;
            display: block;
            overflow-x: auto;
        }

        .gos18-form th,
        .gos18-form td {
            border: 1px solid #333;
            padding: 0.25rem;
            text-align: left;
            vertical-align: middle;
            min-width: 60px;
        }

        @media (min-width: 768px) {
            .gos18-form th,
            .gos18-form td {
                padding: 0.5rem;
            }
        }

        .gos18-form th {
            background-color: #f3f4f6;
            font-weight: 600;
        }

        .gos18-form input[type="text"],
        .gos18-form input[type="date"],
        .gos18-form input[type="tel"],
        .gos18-form input[type="email"],
        .gos18-form input[type="time"],
        .gos18-form textarea {
            width: calc(100% - 0.5rem);
            padding: 0.25rem;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-family: 'Arial', sans-serif;
            background: white;
        }

        @media (min-width: 768px) {
            .gos18-form input[type="text"],
            .gos18-form input[type="date"],
            .gos18-form input[type="tel"],
            .gos18-form input[type="email"],
            .gos18-form input[type="time"],
            .gos18-form textarea {
                font-size: 0.875rem;
            }
        }

        .gos18-form textarea {
            resize: vertical;
            min-height: 60px;
        }

        @media (min-width: 768px) {
            .gos18-form textarea {
                min-height: 80px;
            }
        }

        .gos18-form input[type="checkbox"] {
            margin-right: 0.25rem;
            width: 14px;
            height: 14px;
            vertical-align: middle;
        }

        @media (min-width: 768px) {
            .gos18-form input[type="checkbox"] {
                margin-right: 0.5rem;
                width: 16px;
                height: 16px;
            }
        }

        .gos18-section {
            margin-bottom: 1rem;
        }

        @media (min-width: 768px) {
            .gos18-section {
                margin-bottom: 1.5rem;
            }
        }

        .gos18-section-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            background-color: #e5e7eb;
            padding: 0.375rem;
            border: 1px solid #333;
            text-align: center;
            font-size: 0.875rem;
        }

        @media (min-width: 768px) {
            .gos18-section-title {
                padding: 0.5rem;
                font-size: 1rem;
            }
        }

        /* Responsive table layouts */
        .gos18-responsive-table {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 1rem;
        }

        .gos18-form .prescription-table {
            min-width: 600px;
        }

        /* Stack form fields on mobile */
        @media (max-width: 767px) {
            .gos18-form td[colspan="6"] {
                display: block;
                width: 100%;
            }
            
            .gos18-form td[rowspan] {
                display: block;
                width: 100%;
                border-bottom: none;
            }
        }

        /* Responsive checkbox groups */
        .gos18-checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin: 0.5rem 0;
        }

        .gos18-checkbox-item {
            display: flex;
            align-items: center;
            min-width: 150px;
            margin-bottom: 0.25rem;
        }

        @media (max-width: 767px) {
            .gos18-checkbox-item {
                min-width: 100%;
            }
        }

        .gos18-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e5e7eb;
        }

        .gos18-button {
            flex: 1;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .gos18-download {
            background-color: #3b82f6;
            color: white;
            border: none;
        }

        .gos18-download:hover {
            background-color: #2563eb;
        }

        .gos18-copy {
            background-color: #10b981;
            color: white;
            border: none;
        }

        .gos18-copy:hover {
            background-color: #059669;
        }

        .gos18-toggle {
            background-color: #6366f1;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            margin-top: 1rem;
            width: 100%;
            font-weight: 500;
            transition: all 0.2s;
        }

        .gos18-toggle:hover {
            background-color: #4f46e5;
        }

        .navigation-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            justify-content: space-between;
        }

        .back-tab {
            background: white;
            border: 2px solid #0A3D62;
            color: #0A3D62;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .back-tab:hover {
            background-color: #0A3D62;
            color: white;
        }

        .back-tab:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .back-tab:disabled:hover {
            background: white;
            color: #0A3D62;
        }

        /* Hide specific submit buttons */
        input[value="Submit"]:not([class*="publish"]):not([id*="publish"]) {
            display: none !important;
        }
        
        .form-actions button[type="submit"],
        .submit-wrapper button,
        .form-footer button {
            display: none !important;
        }

        .enhanced-indicator {
            background-color: #f0fdf4;
            border-left: 4px solid #22c55e;
            padding: 0.5rem 1rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            color: #166534;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .enhanced-indicator svg {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }

        @media print {
            .gos18-close,
            .gos18-actions,
            .gos18-toggle,
            .action-buttons,
            .back-button {
                display: none !important;
            }
        }
    </style>
    <!-- Add jsPDF library for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
    <!-- Welcome Screen -->
    <div id="welcome-screen">
        <div class="header">
            <div class="header-content">
                <div class="header-left">
                    <svg class="eye-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    <div>
                        <h1 class="header-title">EyeSpecialist.ai</h1>
                        <p class="header-subtitle">Advanced clinical decision support for ophthalmology</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="card">
                <h2 class="welcome-title">Welcome. Select the presenting condition for clinical guidance.</h2>
                <p class="welcome-description">
                    This advanced tool provides evidence-based triage pathways based on comprehensive clinical algorithms. 
                    Each pathway includes detailed assessment criteria, management protocols, and safety-netting guidance.
                </p>
                <p class="disclaimer">
                    <strong>Clinical Notice:</strong> This tool provides guidance based on established clinical pathways. 
                    Always use your clinical judgement and consider patient-specific factors. Not a substitute for clinical assessment.
                </p>
            </div>

            <div class="condition-grid" id="condition-grid">
                <!-- Conditions will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Assessment Screen -->
    <div id="assessment-screen" class="hidden">
        <div class="header assessment-header">
            <div class="header-content">
                <div class="header-left">
                    <svg class="eye-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    <div>
                        <h1 class="header-title">EyeSpecialist.ai</h1>
                        <p class="header-subtitle" id="assessment-subtitle">Clinical Assessment</p>
                    </div>
                </div>
                <button class="back-button" onclick="startOver()">
                    <svg class="icon" viewBox="0 0 24 24">
                        <line x1="19" y1="12" x2="5" y2="12"></line>
                        <polyline points="12,19 5,12 12,5"></polyline>
                    </svg>
                    Start Over
                </button>
            </div>
        </div>

        <div class="progress-container">
            <div class="progress-content">
                <div class="progress-text">
                    <span id="progress-text">Question 1 of 6</span>
                    <span id="progress-percent">17% Complete</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="red-flags-box hidden" id="red-flags-box">
                <h3 class="red-flags-title">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path>
                        <line x1="12" y1="9" x2="12" y2="13"></line>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                    Red Flags for This Condition
                </h3>
                <ul class="red-flags-list" id="red-flags-list">
                    <!-- Red flags will be populated dynamically -->
                </ul>
            </div>

            <div class="card">
                <div class="pathway-indicator hidden" id="pathway-indicator"></div>
                <h2 class="question-title" id="question-title">Loading question...</h2>
                <p class="question-subtitle hidden" id="question-subtitle"></p>

                <div id="question-options">
                    <!-- Question options will be populated by JavaScript -->
                </div>

                <div class="clinical-note hidden" id="clinical-note"></div>

                <div class="navigation-buttons" id="navigation-buttons">
                    <button class="back-tab" id="back-button" onclick="previousQuestion()" disabled>
                        <svg class="icon" viewBox="0 0 24 24">
                            <line x1="19" y1="12" x2="5" y2="12"></line>
                            <polyline points="12,19 5,12 12,5"></polyline>
                        </svg>
                        Back
                    </button>
                </div>

                <div class="assessment-summary hidden" id="assessment-summary">
                    <h3 class="summary-title">Assessment Summary:</h3>
                    <div class="summary-items" id="summary-items">
                        <!-- Summary items will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Screen -->
    <div id="results-screen" class="hidden">
        <div class="header assessment-header">
            <div class="header-content">
                <div class="header-left">
                    <svg class="eye-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    <div>
                        <h1 class="header-title">EyeSpecialist.ai</h1>
                        <p class="header-subtitle">Clinical Recommendation</p>
                    </div>
                </div>
                <button class="back-button" onclick="startOver()">
                    <svg class="icon" viewBox="0 0 24 24">
                        <line x1="19" y1="12" x2="5" y2="12"></line>
                        <polyline points="12,19 5,12 12,5"></polyline>
                    </svg>
                    New Assessment
                </button>
            </div>
        </div>

        <div class="main-content">
            <div class="card">
                <div class="recommendation-header">
                    <div class="urgency-icon" id="urgency-icon">
                        <!-- Icon will be populated by JavaScript -->
                    </div>
                    <div>
                        <h2 class="recommendation-title" id="recommendation-title">Referral</h2>
                        <p class="recommendation-subtitle" id="recommendation-subtitle">Condition</p>
                    </div>
                </div>

                <div class="reasoning-box">
                    <p class="reasoning-text" id="reasoning-text">Reasoning will appear here</p>
                </div>

                <div class="enhanced-indicator" id="enhanced-indicator" style="display: none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22,4 12,14.01 9,11.01"></polyline>
                    </svg>
                    <span>Enhanced AI analysis applied - comprehensive coverage active</span>
                </div>

                <div class="severity-indicator" id="severity-indicator">
                    <div class="severity-score" id="severity-score">Clinical Severity Score: 0</div>
                    <div class="severity-bar">
                        <div class="severity-fill" id="severity-fill"></div>
                    </div>
                </div>

                <div class="section-margin">
                    <h3 class="section-title">
                        <svg class="icon" viewBox="0 0 24 24">
                            <polyline points="9,18 15,12 9,6"></polyline>
                        </svg>
                        Referral Pathway
                    </h3>
                    <div class="next-steps-box">
                        <p class="next-steps-text" id="next-steps-text">Next steps will appear here</p>
                    </div>
                </div>

                <div class="section-margin">
                    <h3 class="section-title">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                        Management Protocol
                    </h3>
                    <div class="management-box">
                        <h4 class="management-title">Immediate Management</h4>
                        <ul class="management-list" id="immediate-management">
                            <!-- Management steps will be populated by JavaScript -->
                        </ul>
                    </div>
                    <div class="management-box" id="medications-box">
                        <h4 class="management-title">Medications</h4>
                        <ul class="management-list" id="medications-list">
                            <!-- Medications will be populated by JavaScript -->
                        </ul>
                    </div>
                </div>

                <div class="section-margin">
                    <h3 class="section-title">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path>
                            <polyline points="14,2 14,8 20,8"></polyline>
                        </svg>
                        Documentation Required
                    </h3>
                    <ul class="forms-list" id="forms-list">
                        <!-- Forms will be populated by JavaScript -->
                    </ul>
                </div>

                <div class="section-margin">
                    <h3 class="section-title">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                        </svg>
                        Safety-Netting Advice
                    </h3>
                    <ul class="safety-list" id="safety-list">
                        <!-- Safety netting advice will be populated by JavaScript -->
                    </ul>
                </div>

                <div class="clinical-pearl hidden" id="results-clinical-pearl"></div>
            </div>

            <!-- GOS18 Form Toggle Button -->
            <button class="gos18-toggle" onclick="toggleGOS18Form()">
                <svg class="icon" viewBox="0 0 24 24" style="display: inline-block; margin-right: 0.5rem;">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                </svg>
                Generate GOS18 Referral Form
            </button>

            <!-- GOS18 Form Container -->
            <div id="gos18-form-container" class="gos18-container hidden">
                <div class="gos18-header">
                    <div>
                        <h3 class="gos18-title">GOS 18</h3>
                        <p class="gos18-subtitle">Referral/Notification (Always at optometrist)</p>
                        <p class="gos18-subtitle">Please contact the patient if they do not contact you or do not attend</p>
                    </div>
                    <button class="gos18-close" onclick="hideGOS18Form()">âœ• Close</button>
                </div>

                <form id="gos18-form" class="gos18-form">
                    <!-- Patient Details Section -->
                    <div class="gos18-section">
                        <div class="gos18-section-title">CONSULTATION DATE / Patient Details</div>
                        <table>
                            <tr>
                                <td><strong>Title:</strong></td>
                                <td><input type="text" name="title" placeholder="Mr/Mrs/Miss/Ms/Other"></td>
                                <td><strong>DoB:</strong></td>
                                <td><input type="date" name="dob"></td>
                                <td rowspan="3"><strong>Address:</strong></td>
                                <td rowspan="3"><textarea name="address" rows="3"></textarea></td>
                            </tr>
                            <tr>
                                <td><strong>Surname:</strong></td>
                                <td><input type="text" name="surname"></td>
                                <td><strong>Tel (H):</strong></td>
                                <td><input type="tel" name="telHome"></td>
                            </tr>
                            <tr>
                                <td><strong>First Names:</strong></td>
                                <td><input type="text" name="firstName"></td>
                                <td><strong>Tel (M):</strong></td>
                                <td><input type="tel" name="telMobile"></td>
                            </tr>
                            <tr>
                                <td colspan="6">
                                    <strong>Other:</strong> <input type="text" name="other" style="width: 90%;">
                                </td>
                            </tr>
                            <tr>
                                <td colspan="6">
                                    <strong>Post Code:</strong> <input type="text" name="postcode" style="width: 200px;">
                                </td>
                            </tr>
                        </table>
                    </div>

                    <!-- GP Details Section -->
                    <div class="gos18-section">
                        <div class="gos18-section-title">GP Details / Optometrist Details</div>
                        <table>
                            <tr>
                                <td><strong>Name Address:</strong></td>
                                <td><input type="text" name="gpName"></td>
                                <td><strong>Name Address:</strong></td>
                                <td><input type="text" name="optName"></td>
                            </tr>
                            <tr>
                                <td><strong>E-Mail:</strong></td>
                                <td><input type="email" name="gpEmail"></td>
                                <td><strong>E-Mail:</strong></td>
                                <td><input type="email" name="optEmail"></td>
                            </tr>
                            <tr>
                                <td><strong>Tel:</strong></td>
                                <td><input type="tel" name="gpTel"></td>
                                <td><strong>Tel:</strong></td>
                                <td><input type="tel" name="optTel"></td>
                            </tr>
                        </table>
                    </div>

                    <!-- Latest Spectacle Prescription Section -->
                    <div class="gos18-section">
                        <div class="gos18-section-title">Latest Spectacle Prescription</div>
                        <div class="gos18-responsive-table">
                            <table class="prescription-table">
                                <thead>
                                    <tr>
                                        <th>Rx</th>
                                        <th>Vision</th>
                                        <th>Sph</th>
                                        <th>Cyl</th>
                                        <th>Axis</th>
                                        <th>VA</th>
                                        <th>Dist. Prism PH Acuity</th>
                                        <th>Add</th>
                                        <th>Nr. Prism</th>
                                        <th>Near VA</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>RE</td>
                                        <td><input type="text" name="reVision"></td>
                                        <td><input type="text" name="reSph"></td>
                                        <td><input type="text" name="reCyl"></td>
                                        <td><input type="text" name="reAxis"></td>
                                        <td><input type="text" name="reVA"></td>
                                        <td><input type="text" name="reDistPrism"></td>
                                        <td><input type="text" name="reAdd"></td>
                                        <td><input type="text" name="reNrPrism"></td>
                                        <td><input type="text" name="reNearVA"></td>
                                    </tr>
                                    <tr>
                                        <td>LE</td>
                                        <td><input type="text" name="leVision"></td>
                                        <td><input type="text" name="leSph"></td>
                                        <td><input type="text" name="leCyl"></td>
                                        <td><input type="text" name="leAxis"></td>
                                        <td><input type="text" name="leVA"></td>
                                        <td><input type="text" name="leDistPrism"></td>
                                        <td><input type="text" name="leAdd"></td>
                                        <td><input type="text" name="leNrPrism"></td>
                                        <td><input type="text" name="leNearVA"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Mydriasis and IOP Section -->
                    <div class="gos18-section">
                        <table>
                            <tr>
                                <td colspan="3" style="text-align: center;"><strong>Mydriasis</strong></td>
                                <td colspan="3" style="text-align: center;"><strong>Intraocular Pressure (IOP)</strong></td>
                            </tr>
                            <tr>
                                <td>Eye</td>
                                <td>%</td>
                                <td>Drug</td>
                                <td>RE</td>
                                <td>Time: <input type="time" name="iopTime"></td>
                                <td>Contact <input type="checkbox" name="iopContact"> Non Contact <input type="checkbox" name="iopNonContact"></td>
                            </tr>
                            <tr>
                                <td>RE LE</td>
                                <td><input type="text" name="mydriasisPercent"></td>
                                <td><input type="text" name="mydriasisDrug"></td>
                                <td>LE</td>
                                <td><input type="text" name="leIOP"></td>
                                <td><input type="text" name="iopMethod"></td>
                            </tr>
                        </table>
                    </div>

                    <!-- IT Fields Section -->
                    <div class="gos18-section">
                        <div class="gos18-section-title">IT Fields / Provisional Diagnosis</div>
                        <table>
                            <tr>
                                <td><strong>Imaging:</strong></td>
                                <td colspan="5">
                                    <input type="checkbox" name="imaging1"> Enclosed
                                    <input type="checkbox" name="imaging2"> Emailed
                                    <input type="checkbox" name="imaging3"> Sent with patient
                                </td>
                            </tr>
                            <tr>
                                <td colspan="6">
                                    <strong>Salient Symptoms, Signs, History, Clinical Findings, Reason for Referral and Provisional Diagnosis:</strong><br>
                                    <textarea name="clinicalFindings" rows="4" style="width: 100%;" id="gos18-clinical-findings"></textarea>
                                </td>
                            </tr>
                        </table>
                    </div>

                    <!-- Referral Section -->
                    <div class="gos18-section">
                        <div class="gos18-section-title">Referral</div>
                        <table>
                            <tr>
                                <td colspan="6">
                                    <div class="gos18-checkbox-group">
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="referralHES" id="referralHES"> 
                                            <label for="referralHES">HES</label>
                                        </div>
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="referralOcular" id="referralOcular"> 
                                            <label for="referralOcular">Ocular Emergency - to Hospital A&E Eye Service</label>
                                        </div>
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="referralSemi" id="referralSemi"> 
                                            <label for="referralSemi">Semi-Urgent - to HES within 4 weeks</label>
                                        </div>
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="referralRoutine" id="referralRoutine"> 
                                            <label for="referralRoutine">Routine - to HES within 12 weeks</label>
                                        </div>
                                    </div>
                                    
                                    <strong>Supervised by:</strong><br>
                                    <div class="gos18-checkbox-group">
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="supervisedCataract"> 
                                            <label>Cataract</label>
                                        </div>
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="supervisedGeneral"> 
                                            <label>General (Medical/Ophthalmology)</label>
                                        </div>
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="supervisedDiabetic"> 
                                            <label>Diabetic/Dis/Adv</label>
                                        </div>
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="supervisedLow"> 
                                            <label>Low Vision</label>
                                        </div>
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="supervisedOther"> 
                                            <label>Other Medical Retinal</label>
                                        </div>
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="supervisedGlaucoma"> 
                                            <label>Glaucoma</label>
                                        </div>
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="supervisedSquint"> 
                                            <label>Squint/Ocular Motility</label>
                                        </div>
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="supervisedYAG"> 
                                            <label>YAG Laser</label>
                                        </div>
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="supervisedAdnexal"> 
                                            <label>Paed: Adnexal/Orbits</label>
                                        </div>
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="supervisedExternal"> 
                                            <label>External Eye/Adnexa</label>
                                        </div>
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="supervisedOrtho"> 
                                            <label>Orthoptics</label>
                                        </div>
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="supervisedMacular"> 
                                            <label>Macular/Intravitreal</label>
                                        </div>
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="supervisedPaed"> 
                                            <label>Paed: General/Refrac</label>
                                        </div>
                                    </div>
                                    
                                    <div style="margin-top: 0.5rem;">
                                        <strong>Not otherwise specified:</strong> 
                                        <input type="text" name="notSpecified" style="width: 50%;">
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="6">
                                    <div class="gos18-checkbox-group" style="margin-top: 1rem;">
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="referralGP"> 
                                            <label>GP (For Systemic management or appropriate)</label>
                                        </div>
                                        <div class="gos18-checkbox-item">
                                            <input type="checkbox" name="referralNotification"> 
                                            <label>Notification Only</label>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </div>

                    <!-- Optometrist Details Section -->
                    <div class="gos18-section">
                        <div class="gos18-section-title">Optometrist Name / Date</div>
                        <table>
                            <tr>
                                <td><strong>Signature:</strong></td>
                                <td><input type="text" name="optSignature" placeholder="Type name"></td>
                                <td><strong>GOC No:</strong></td>
                                <td><input type="text" name="gocNumber"></td>
                                <td><strong>Date:</strong></td>
                                <td><input type="date" name="referralDate" id="referralDate"></td>
                            </tr>
                        </table>
                    </div>

                    <!-- Footer Note -->
                    <div class="gos18-section">
                        <p style="font-size: 0.75rem; text-align: center; color: #6b7280;">
                            Please obtain consent from the patient if not already given, and provide feedback to the referring optometrist Referral Letter:<br>
                            <input type="checkbox" name="patientCopy"> Patient Copy
                            <input type="checkbox" name="postedToGP"> Posted to GP
                            <input type="checkbox" name="handedToPatient"> Handed to Pt to take to GP/HES
                            <input type="checkbox" name="faxedToHES"> Faxed to HES<br>
                            GOS018 Unrelated Excel.xlsx
                        </p>
                    </div>
                </form>

                <div class="gos18-actions">
                    <button type="button" class="gos18-button gos18-download" onclick="downloadGOS18()">
                        <svg class="icon" viewBox="0 0 24 24" style="display: inline-block; margin-right: 0.5rem;">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        Download GOS18
                    </button>
                    <button type="button" class="gos18-button gos18-copy" onclick="copyGOS18()">
                        <svg class="icon" viewBox="0 0 24 24" style="display: inline-block; margin-right: 0.5rem;">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                        Copy GOS18
                    </button>
                </div>
            </div>

            <div class="action-buttons">
                <button class="secondary-button" onclick="startOver()">New Assessment</button>
                <button class="copy-button" id="copy-button" onclick="copyAssessmentResults()">Copy Assessment</button>
                <button class="primary-button" onclick="window.print()">Generate Referral Letter</button>
            </div>
            
            <!-- Debug section - remove in production -->
            <div style="margin-top: 2rem; padding: 1rem; background: #f3f4f6; border-radius: 0.5rem; font-size: 0.75rem;">
                <strong>Debug Info:</strong>
                <div id="debug-info" style="margin-top: 0.5rem; font-family: monospace;">
                    Urgency: <span id="debug-urgency"></span><br>
                    Severity Score: <span id="debug-score"></span><br>
                    Match Type: <span id="debug-match"></span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Application state
        let currentStep = 'welcome';
        let selectedCondition = null;
        let responses = {};
        let currentQuestionIndex = 0;
        let assessmentPath = [];
        let recommendation = null;
        let decisionPath = [];
        let questionHistory = []; // Track question navigation history

        // Helper function to get timeframe based on urgency
        function getTimeframeForUrgency(urgency) {
            const timeframes = {
                'emergency': 'Immediate/Same-day',
                'urgent': 'Within 24-48 hours',
                'semi-urgent': 'Within 48-72 hours',
                'routine': 'Routine (within 4-12 weeks)'
            };
            return timeframes[urgency] || 'Within 48 hours';
        }

        // Clinical notes templates for GOS18
        const clinicalNotesTemplates = {
            "Flashes & Floaters": {
                "emergency": (responses) => 
                    `URGENT: ${responses.floater_increase === 'Yes - shower of floaters' ? 'Shower of new floaters' : 'Acute symptoms'} 
                    with ${responses.flash_pattern || 'flashing lights'}. 
                    ${responses.visual_field === 'Yes - progressive' ? 'PROGRESSIVE FIELD DEFECT - ?RD. ' : ''}
                    Onset ${responses.onset_timing}. Risk factors: ${responses.risk_factors}. 
                    Requires immediate dilated retinal examination to exclude retinal tear/detachment.`,
                
                "urgent": (responses) => 
                    `Recent onset ${responses.flash_pattern || 'flashes'} and floaters, started ${responses.onset_timing}. 
                    ${responses.risk_factors !== 'None' ? `High risk patient (${responses.risk_factors}). ` : ''}
                    No field defect currently. Requires dilated peripheral retinal examination within 48 hours 
                    to exclude retinal tear. Patient counselled re RD symptoms.`,
                
                "routine": (responses) => 
                    `Chronic floaters ${responses.onset_timing}. No recent change. 
                    Vision ${responses.vision_quality}. No field defect. 
                    Likely benign PVD but requires confirmation with dilated examination.`
            },
            "Sudden Vision Loss": {
                "emergency": (responses) => 
                    `EMERGENCY: Sudden ${responses.laterality} vision loss (${responses.visual_pattern}). 
                    ${responses.gca_symptoms !== 'None' ? `GCA SYMPTOMS: ${responses.gca_symptoms} - STARTED HIGH-DOSE STEROIDS. ` : ''}
                    Onset ${responses.onset_pattern}. ${responses.pain_present}. 
                    Requires immediate assessment and treatment. ${responses.duration === 'Not transient' ? 'Persistent loss.' : ''}`,
                
                "urgent": (responses) => 
                    `Acute ${responses.laterality} visual disturbance. ${responses.visual_pattern} pattern. 
                    Onset ${responses.onset_pattern}. ${responses.pain_present}. 
                    ${responses.duration !== 'Not transient' ? `Transient episode lasting ${responses.duration}. ` : ''}
                    Requires urgent assessment for ${responses.duration === '<5 minutes' ? 'TIA/stroke risk' : 'cause'}.`,
                
                "routine": (responses) => 
                    `${responses.onset_pattern} vision loss, ${responses.laterality}. 
                    ${responses.visual_pattern} pattern. No acute features. 
                    Requires ophthalmology assessment to determine cause and optimize management.`
            }
        };

        // Severity scoring system
        const severityScoring = {
            "Red Eye": {
                "vision_affected": { "Normal vision": 0, "Mild blur": 2, "Significant vision loss": 5 },
                "pain_severity": { "No pain": 0, "Mild discomfort": 1, "Severe pain with photophobia": 4 },
                "recent_surgery": { "Yes": 5, "No": 0 },
                "contact_lens": { "Yes": 3, "No": 0 },
                "discharge": { "No discharge": 0, "Watery discharge": 1, "Mucopurulent discharge": 2 },
                "pupil_size": { "Smaller/same as other eye": 1, "Larger than other eye": 4, "Fixed and dilated": 5 },
                "corneal_staining": { "No staining": 0, "Punctate staining": 2, "Epithelial defect": 4, "Dendritic pattern": 5, "Not tested": 1 }
            },
            "Flashes & Floaters": {
                "onset_timing": { "Within 24 hours": 5, "Within 1 week": 3, "Within 1 month": 2, "Over 1 month ago": 1 },
                "floater_increase": { "Yes - shower of floaters": 5, "Yes - few new floaters": 3, "No change": 1, "First time floaters": 2 },
                "visual_field": { "Yes - progressive": 5, "Yes - stable": 3, "No": 0 },
                "flash_pattern": { "Arc-like flashes in periphery": 4, "Central sparkles": 2, "Zigzag patterns": 2, "No flashes": 0 },
                "risk_factors": { "High myopia (>-6D)": 3, "Previous retinal problems": 4, "Recent eye surgery": 3, "Family history RD": 2, "None": 0 },
                "vision_quality": { "Normal": 0, "Slightly blurred": 2, "Significantly reduced": 5 }
            },
            "Sudden Vision Loss": {
                "laterality": { "One eye (monocular)": 3, "Both eyes (binocular)": 4, "Unsure": 2 },
                "onset_pattern": { "Sudden (seconds)": 5, "Rapid (minutes)": 4, "Gradual (hours)": 2, "Progressive (days)": 1 },
                "pain_present": { "No pain": 1, "Mild discomfort": 2, "Severe pain": 4, "Pain on eye movement": 3 },
                "gca_symptoms": { "Temporal headache": 5, "Jaw claudication": 5, "Scalp tenderness": 4, "None": 0, "Multiple symptoms": 5 },
                "visual_pattern": { "Complete blackout": 5, "Central scotoma": 3, "Altitudinal defect": 4, "Curtain-like": 4, "Patchy loss": 2 },
                "duration": { "Not transient": 3, "<5 minutes": 2, "5-30 minutes": 1, ">30 minutes": 2, "Recurring episodes": 3 }
            },
            "Raised IOP": {
                "iop_level": { "<21 mmHg": 0, "21-30 mmHg": 2, "31-40 mmHg": 4, ">40 mmHg": 5, "Not measured but symptomatic": 3 },
                "symptoms": { "No symptoms": 0, "Mild headache": 2, "Severe pain + nausea": 5, "Halos around lights": 3, "Red eye": 3 },
                "pupil_status": { "Normal reactive": 0, "Sluggish": 3, "Mid-dilated and fixed": 5, "Not assessed": 1 },
                "medication_history": { "No eye drops": 0, "Steroid eye drops": 3, "Glaucoma drops": 1, "Recent dilating drops": 2 },
                "risk_assessment": { "Hypermetropia": 2, "Family history glaucoma": 2, "Asian ethnicity": 2, "Shallow anterior chamber": 3, "None identified": 0 }
            },
            "Eyelid Problems": {
                "problem_type": { "Swelling": 3, "Malposition": 1, "Lump/lesion": 3, "Redness/inflammation": 2 },
                "swelling_extent": { "Localized (stye/chalazion)": 1, "Whole lid": 3, "Lid + cheek": 5, "Not applicable": 0 },
                "systemic_features": { "None": 0, "Mild malaise": 2, "Fever": 4, "Systemically unwell": 5 },
                "eye_movement": { "Normal": 0, "Slightly restricted": 3, "Significantly restricted": 5, "Not tested": 1 },
                "lesion_features": { "Smooth, mobile": 1, "Irregular edges": 3, "Ulcerated": 5, "Loss of lashes": 5, "Not applicable": 0 },
                "duration": { "<1 week": 3, "1-4 weeks": 2, "1-3 months": 1, ">3 months": 1 }
            },
            "Watery Eyes": {
                "associated_symptoms": { "No - just watering": 1, "Irritation/grittiness": 2, "Redness": 3, "Discharge": 4 },
                "laterality": { "One eye": 3, "Both eyes equally": 1, "Both but one worse": 2 },
                "timing": { "Constant": 3, "Outdoors/wind": 1, "Reading/computer": 2, "Morning only": 1 },
                "lid_position": { "Yes": 0, "Lower lid turning out": 3, "Lower lid turning in": 3, "Facial weakness": 4 },
                "previous_episodes": { "No": 0, "Occasional styes": 1, "Recurrent infections": 3, "Dacryocystitis": 5 }
            },
            "Pediatric Eye Problems": {
                "age_group": { "0-6 months": 4, "6-12 months": 3, "1-3 years": 2, "3-8 years": 1, ">8 years": 1 },
                "presenting_problem": { "Squint/misalignment": 3, "Red/sticky eye": 2, "Poor vision": 4, "Abnormal appearance": 5, "Watery eye": 1 },
                "red_reflex": { "Normal both eyes": 0, "Absent/white": 5, "Asymmetric": 4, "Not checked": 2 },
                "onset_timing": { "Since birth": 3, "Recent weeks": 2, "Recent months": 1, "Intermittent": 1 },
                "development": { "Yes": 0, "Delayed": 3, "Regression": 4, "Not sure": 1 },
                "family_history": { "None": 0, "Squint": 2, "Lazy eye": 2, "Childhood cataracts": 4, "Retinoblastoma": 5 }
            },
            "Diplopia": {
                "type": { "Resolves with one eye covered (binocular)": 3, "Persists with one eye (monocular)": 1, "Variable": 2, "Unsure": 2 },
                "onset": { "Sudden onset": 5, "Gradual over days": 3, "Progressive over weeks": 2, "Long-standing": 1 },
                "pattern": { "Constant": 4, "Distance only": 2, "Near only": 2, "Varies through day": 3, "Certain directions": 2 },
                "associated_features": { "None": 0, "Headache": 2, "Ptosis": 4, "Facial weakness": 5, "Pupil abnormality": 5 },
                "risk_factors": { "None": 0, "Diabetes": 2, "Hypertension": 2, "Recent trauma": 3, "Thyroid disease": 2 }
            },
            "Headaches with Visual Symptoms": {
                "visual_symptoms": { "Zigzag lines/fortification": 1, "Transient vision loss": 3, "Persistent blur": 4, "Double vision": 4, "Visual field defect": 5 },
                "headache_pattern": { "Classic migraine": 1, "Worse on waking": 4, "Sudden severe": 5, "Progressive worsening": 4, "With eye movement": 3 },
                "fundoscopy": { "Normal": 0, "Disc swelling": 5, "Disc pallor": 4, "Not examined": 2 },
                "age_symptoms": { "<50 years, familiar pattern": 1, ">50 years, new pattern": 4, "Any age, progressive": 3, "Any age, sudden onset": 4 },
                "associated_features": { "Nausea only": 1, "Jaw claudication": 5, "Scalp tenderness": 5, "Red painful eye": 4, "None": 0 }
            },
            "Corneal Problems": {
                "precipitating_event": { "Trauma/injury": 3, "Foreign body": 2, "Chemical exposure": 5, "No specific event": 1 },
                "contact_lens_user": { "Yes - current user": 4, "Yes - but not recently": 2, "No": 0, "Overnight wear": 5 },
                "pain_level": { "No pain": 0, "Mild discomfort": 1, "Moderate pain": 3, "Severe pain": 5 },
                "vision_impact": { "No change": 0, "Slight blur": 2, "Significant reduction": 4, "Can't see details": 5 },
                "fluorescein_pattern": { "No uptake": 0, "Linear abrasion": 2, "Punctate staining": 2, "Dendritic pattern": 5, "Large epithelial defect": 4, "Not tested": 1 },
                "associated_features": { "White infiltrate": 4, "Hypopyon": 5, "Corneal thinning": 5, "None visible": 0 }
            }
        };

        // Safety netting configuration
        const safetyNettingConfig = {
            "Flashes & Floaters": {
                "emergency": [
                    "Return IMMEDIATELY if curtain/shadow develops in vision",
                    "Seek urgent care if sudden shower of new floaters",
                    "Call 999 if sudden complete vision loss",
                    "Keep mobile phone charged and accessible"
                ],
                "urgent": [
                    "Return urgently if visual field defect develops",
                    "Monitor for increasing floaters or flashes",
                    "Avoid heavy lifting/straining until reviewed",
                    "Have someone available to drive if vision deteriorates"
                ],
                "routine": [
                    "Annual dilated examination if high myope",
                    "Return if symptoms change or worsen",
                    "Maintain regular eye examinations",
                    "Report any new visual symptoms promptly"
                ]
            },
            "Sudden Vision Loss": {
                "emergency": [
                    "Take prescribed steroids EXACTLY as directed (if GCA)",
                    "Do NOT stop steroids without medical advice",
                    "Return IMMEDIATELY if vision worsens or other eye affected",
                    "Keep emergency contact numbers readily available"
                ],
                "urgent": [
                    "Monitor for vision changes in either eye",
                    "Take aspirin as prescribed (if vascular cause)",
                    "Attend all follow-up appointments",
                    "Control vascular risk factors strictly"
                ],
                "routine": [
                    "Regular monitoring of vision",
                    "Optimize cardiovascular risk factors",
                    "Report any new symptoms immediately",
                    "Maintain prescribed medications"
                ]
            }
        };

        // Documentation requirements
        const documentationRequirements = {
            "Flashes & Floaters": {
                forms: ["Visual field diagram if defect present", "Detailed symptom timeline", "Risk factor assessment"],
                specific: {
                    "emergency": ["Document exact field defect", "Time of onset", "Progression rate"],
                    "urgent": ["Number and pattern of floaters", "Character of flashes", "Previous ocular history"],
                    "routine": ["Duration of symptoms", "Previous episodes", "Family history"]
                }
            },
            "Sudden Vision Loss": {
                forms: ["GCA pathway form (if applicable)", "Stroke/TIA assessment", "Visual acuity documentation"],
                specific: {
                    "emergency": ["Exact time of vision loss", "ESR/CRP if GCA suspected", "Document RAPD"],
                    "urgent": ["Pattern of vision loss diagram", "Cardiovascular risk factors", "Medication history"],
                    "routine": ["Progression timeline", "Associated symptoms", "Previous investigations"]
                }
            }
        };

        // Immediate management configuration
        const immediateManagementConfig = {
            "Flashes & Floaters": {
                "emergency": [
                    "Position patient appropriately if retinal detachment",
                    "Urgent ophthalmology referral",
                    "Document visual acuity and fields",
                    "Advise against driving"
                ],
                "urgent": [
                    "Dilated fundoscopy if possible",
                    "Document all findings clearly",
                    "Safety-net advice crucial",
                    "Book urgent retinal examination"
                ],
                "routine": [
                    "Reassurance if appropriate",
                    "Explain benign PVD process",
                    "Routine referral if needed",
                    "Annual screening if high risk"
                ]
            },
            "Sudden Vision Loss": {
                "emergency": [
                    "Prednisolone 60-80mg STAT if GCA suspected",
                    "Urgent blood tests (ESR, CRP, FBC)",
                    "Consider admission if bilateral",
                    "Protect remaining vision"
                ],
                "urgent": [
                    "Start aspirin 300mg if vascular cause",
                    "Arrange carotid doppler if amaurosis",
                    "Document pupil reactions",
                    "Cardiovascular assessment"
                ],
                "routine": [
                    "Check for reversible causes",
                    "Optimize risk factors",
                    "Regular monitoring",
                    "Consider driving regulations"
                ]
            }
        };

        // Medication protocols
        const medicationProtocols = {
            "Flashes & Floaters": {
                "emergency": {
                    medications: ["No specific medications", "Avoid aspirin pre-operatively"],
                    notes: "Surgical management likely required"
                },
                "urgent": {
                    medications: ["No routine medications needed"],
                    notes: "Treatment depends on findings"
                },
                "routine": {
                    medications: ["No medications required"],
                    notes: "Reassurance and monitoring"
                }
            },
            "Sudden Vision Loss": {
                "emergency": {
                    medications: [
                        "Prednisolone 60-80mg PO STAT (if GCA)",
                        "Aspirin 300mg PO STAT (if embolic)",
                        "Consider IV methylpred if optic neuritis"
                    ],
                    notes: "Do NOT delay steroids for tests if GCA suspected"
                },
                "urgent": {
                    medications: [
                        "Aspirin 300mg then 75mg daily",
                        "Statin if not contraindicated",
                        "Antihypertensives as needed"
                    ],
                    notes: "Full vascular risk management"
                },
                "routine": {
                    medications: [
                        "Optimize existing medications",
                        "Consider aspirin if vascular risk"
                    ],
                    notes: "Focus on risk factor modification"
                }
            }
        };

        // Function to calculate severity score
        function calculateSeverityScore(condition, responses) {
            let totalScore = 0;
            const scoring = severityScoring[condition];
            
            if (!scoring) {
                console.log('No scoring found for condition:', condition);
                return 0;
            }
            
            Object.entries(responses).forEach(([questionId, answer]) => {
                if (scoring[questionId] && scoring[questionId][answer] !== undefined) {
                    totalScore += scoring[questionId][answer];
                    console.log(`Question: ${questionId}, Answer: ${answer}, Score: ${scoring[questionId][answer]}`);
                }
            });
            
            console.log('Total severity score:', totalScore);
            return totalScore;
        }

        // Function to determine urgency by score
        function calculateUrgencyByScore(totalScore, condition) {
            // Adjusted thresholds based on condition
            const thresholds = {
                "Red Eye": { emergency: 8, urgent: 4 },
                "Flashes & Floaters": { emergency: 10, urgent: 6 },
                "Sudden Vision Loss": { emergency: 9, urgent: 5 },
                "Raised IOP": { emergency: 10, urgent: 6 },
                "Eyelid Problems": { emergency: 12, urgent: 6 },
                "Watery Eyes": { emergency: 10, urgent: 5 },
                "Pediatric Eye Problems": { emergency: 9, urgent: 5 },
                "Diplopia": { emergency: 10, urgent: 5 },
                "Headaches with Visual Symptoms": { emergency: 10, urgent: 6 },
                "Corneal Problems": { emergency: 10, urgent: 5 }
            };
            
            const threshold = thresholds[condition] || { emergency: 10, urgent: 5 };
            
            if (totalScore >= threshold.emergency) return "emergency";
            if (totalScore >= threshold.urgent) return "urgent";
            return "routine";
        }

        // Comprehensive clinical schema with detailed pathways
        const clinicalSchema = {
            "Red Eye": {
                "description": "Comprehensive assessment for red eye presentations including infection, inflammation, and sight-threatening conditions",
                "pathways": ["Unilateral", "Bilateral", "Contact lens-related", "Post-operative"],
                "redFlags": [
                    "Recent cataract surgery or intravitreal injection (last 4 weeks)",
                    "Severe headache with vomiting",
                    "Pain waking patient at night",
                    "Reduced vision",
                    "Contact lens wearer with symptoms",
                    "Preceding trauma (blunt/high velocity/chemical)"
                ],
                "questions": [
                    {
                        "id": "laterality",
                        "text": "Is the red eye unilateral or bilateral?",
                        "options": ["Unilateral", "Bilateral"],
                        "clinicalNote": "Bilateral red eye often suggests allergic or infective causes, while unilateral may indicate more serious pathology"
                    },
                    {
                        "id": "recent_surgery",
                        "text": "Has the patient had recent eye surgery or injection?",
                        "subtitle": "Within the last 4 weeks",
                        "options": ["Yes", "No"],
                        "clinicalNote": "Post-operative red eye requires urgent assessment to exclude endophthalmitis"
                    },
                    {
                        "id": "contact_lens",
                        "text": "Is the patient a contact lens wearer?",
                        "options": ["Yes", "No"],
                        "clinicalNote": "Contact lens-related keratitis requires different management and has higher risk"
                    },
                    {
                        "id": "pain_severity",
                        "text": "What is the severity of pain?",
                        "options": ["No pain", "Mild discomfort", "Severe pain with photophobia"],
                        "clinicalNote": "Severe pain with photophobia suggests serious pathology (uveitis, keratitis, scleritis)"
                    },
                    {
                        "id": "discharge",
                        "text": "Is there discharge present?",
                        "subtitle": "Note the type if present",
                        "options": ["No discharge", "Watery discharge", "Mucopurulent discharge"],
                        "clinicalNote": "Mucopurulent suggests bacterial; watery suggests viral or allergic"
                    },
                    {
                        "id": "vision_affected",
                        "text": "Is vision affected?",
                        "options": ["Normal vision", "Mild blur", "Significant vision loss"],
                        "clinicalNote": "Vision loss with red eye is always concerning and requires urgent assessment"
                    },
                    {
                        "id": "pupil_size",
                        "text": "Compare pupil size in affected eye",
                        "options": ["Smaller/same as other eye", "Larger than other eye", "Fixed and dilated"],
                        "clinicalNote": "Large pupil with red eye suggests acute angle closure glaucoma"
                    },
                    {
                        "id": "corneal_staining",
                        "text": "Does the cornea stain with fluorescein?",
                        "subtitle": "If fluorescein available",
                        "options": ["No staining", "Punctate staining", "Epithelial defect", "Dendritic pattern", "Not tested"],
                        "clinicalNote": "Dendritic pattern suggests herpetic keratitis; never use steroids without specialist input"
                    }
                ],
                "triageLogic": {
                    "emergency": [
                        {
                            "criteria": ["recent_surgery:Yes", "vision_affected:Significant vision loss"],
                            "condition": "Suspected endophthalmitis",
                            "management": ["URGENT ophthalmology referral", "Document visual acuity", "No topical treatment"]
                        },
                        {
                            "criteria": ["pain_severity:Severe pain with photophobia", "pupil_size:Larger than other eye"],
                            "condition": "Acute angle closure glaucoma",
                            "management": ["IMMEDIATE ophthalmology referral", "Check IOP if available", "Systemic analgesia"]
                        },
                        {
                            "criteria": ["contact_lens:Yes", "pain_severity:Severe pain with photophobia", "corneal_staining:Epithelial defect"],
                            "condition": "Contact lens-related keratitis",
                            "management": ["Same-day ophthalmology", "Stop contact lens use", "DO NOT diagnose as herpes simplex"]
                        }
                    ],
                    "urgent": [
                        {
                            "criteria": ["pain_severity:Severe pain with photophobia", "pupil_size:Smaller/same as other eye"],
                            "condition": "Anterior uveitis",
                            "management": ["Same-day ophthalmology referral", "Check for systemic associations", "No topical steroids"]
                        },
                        {
                            "criteria": ["corneal_staining:Dendritic pattern"],
                            "condition": "Herpetic keratitis",
                            "management": ["Same-day ophthalmology", "Antiviral therapy under specialist guidance only"]
                        },
                        {
                            "criteria": ["pain_severity:Severe pain with photophobia", "discharge:No discharge"],
                            "condition": "Scleritis",
                            "management": ["Same-day referral", "Consider systemic associations", "Oral NSAIDs may help"]
                        }
                    ],
                    "routine": [
                        {
                            "criteria": ["laterality:Bilateral", "discharge:Mucopurulent discharge"],
                            "condition": "Bacterial conjunctivitis",
                            "management": ["Chloramphenicol 1% QDS 7 days", "Hygiene advice", "Review if no improvement in 48-72h"]
                        },
                        {
                            "criteria": ["laterality:Bilateral", "discharge:Watery discharge", "pain_severity:No pain"],
                            "condition": "Allergic conjunctivitis",
                            "management": ["Preservative-free lubricants", "Olopatadine BD", "Allergen avoidance advice"]
                        },
                        {
                            "criteria": ["pain_severity:Mild discomfort", "vision_affected:Normal vision"],
                            "condition": "Episcleritis",
                            "management": ["Cold compresses", "Lubricants", "Oral NSAIDs", "Reassurance - self-limiting"]
                        }
                    ]
                },
                // Default rules for undefined combinations
                "semiUrgent": [
                    {
                        "criteria": ["vision_affected:Mild blur"],
                        "condition": "Visual disturbance requiring assessment",
                        "management": ["Optometry review within 48-72 hours", "Document visual acuity", "Monitor symptoms"]
                    },
                    {
                        "criteria": ["pain_severity:Mild discomfort", "discharge:Watery discharge"],
                        "condition": "Mild external eye inflammation",
                        "management": ["Preservative-free lubricants QDS", "Cold compresses", "Review if no improvement in 5 days"]
                    }
                ],
                "defaultRules": {
                    "visionBased": {
                        "vision_affected:Significant vision loss": {
                            "condition": "Unexplained vision loss requiring urgent assessment",
                            "urgency": "emergency",
                            "management": ["Same-day ophthalmology assessment", "Document visual acuity", "Rule out serious pathology"]
                        },
                        "vision_affected:Mild blur": {
                            "condition": "Mild visual disturbance",
                            "urgency": "urgent",
                            "management": ["Eye examination within 48 hours", "Consider refractive cause", "Monitor progression"]
                        },
                        "vision_affected:Normal vision": {
                            "condition": "External eye condition without vision threat",
                            "urgency": "routine",
                            "management": ["Conservative management", "Lubricants", "Review if persists beyond 1 week"]
                        }
                    },
                    "symptomBased": {
                        "recent_surgery:Yes": {
                            "condition": "Post-operative complication",
                            "urgency": "emergency",
                            "management": ["Urgent ophthalmology same day", "Do not delay referral", "Document all findings"]
                        },
                        "contact_lens:Yes": {
                            "condition": "Contact lens-related complication",
                            "urgency": "urgent",
                            "management": ["Stop lens wear immediately", "Urgent review within 24h", "Consider microbial keratitis"]
                        },
                        "pain_severity:Severe pain with photophobia": {
                            "condition": "Severe ocular inflammation",
                            "urgency": "urgent",
                            "management": ["Same-day assessment", "Rule out serious causes", "Analgesia"]
                        }
                    },
                    "stainBased": {
                        "corneal_staining:Dendritic pattern": {
                            "condition": "Herpetic keratitis",
                            "urgency": "urgent",
                            "management": ["Same-day ophthalmology", "Antiviral therapy", "NO steroids without supervision"]
                        },
                        "corneal_staining:Epithelial defect": {
                            "condition": "Corneal epithelial defect",
                            "urgency": "urgent",
                            "management": ["Urgent assessment", "Risk of infection", "Prophylactic antibiotics"]
                        }
                    }
                }
            },
            "Flashes & Floaters": {
                "description": "Assessment for posterior vitreous detachment and retinal pathology",
                "pathways": ["Acute onset", "Chronic symptoms", "High-risk features"],
                "redFlags": [
                    "Shower of floaters/cobwebs",
                    "Progressive visual field loss",
                    "Curtain/shadow in vision",
                    "Recent onset arc-like flashes",
                    "High myopia (>-6D)",
                    "Previous retinal detachment"
                ],
                "questions": [
                    {
                        "id": "onset_timing",
                        "text": "When did symptoms begin?",
                        "options": ["Within 24 hours", "Within 1 week", "Within 1 month", "Over 1 month ago"],
                        "clinicalNote": "Acute onset requires urgent assessment to exclude retinal tear"
                    },
                    {
                        "id": "floater_increase",
                        "text": "Have floaters increased?",
                        "subtitle": "Compare to baseline",
                        "options": ["Yes - shower of floaters", "Yes - few new floaters", "No change", "First time floaters"],
                        "clinicalNote": "Shower of floaters suggests vitreous hemorrhage from retinal tear"
                    },
                    {
                        "id": "visual_field",
                        "text": "Any visual field loss?",
                        "subtitle": "Shadow, curtain, or missing area",
                        "options": ["Yes - progressive", "Yes - stable", "No"],
                        "clinicalNote": "Progressive field loss indicates retinal detachment requiring emergency surgery"
                    },
                    {
                        "id": "flash_pattern",
                        "text": "Describe the flashes",
                        "options": ["Arc-like flashes in periphery", "Central sparkles", "Zigzag patterns", "No flashes"],
                        "clinicalNote": "Peripheral arc flashes suggest vitreoretinal traction"
                    },
                    {
                        "id": "risk_factors",
                        "text": "Risk factors present?",
                        "options": ["High myopia (>-6D)", "Previous retinal problems", "Recent eye surgery", "Family history RD", "None"],
                        "clinicalNote": "Multiple risk factors significantly increase retinal detachment risk"
                    },
                    {
                        "id": "vision_quality",
                        "text": "Current vision quality?",
                        "options": ["Normal", "Slightly blurred", "Significantly reduced"],
                        "clinicalNote": "Vision loss with flashes/floaters is concerning for detachment"
                    }
                ],
                "triageLogic": {
                    "emergency": [
                        {
                            "criteria": ["visual_field:Yes - progressive"],
                            "condition": "Retinal detachment",
                            "management": ["IMMEDIATE ophthalmology", "Posture if macula-on", "Surgery within 24h"]
                        },
                        {
                            "criteria": ["floater_increase:Yes - shower of floaters", "flash_pattern:Arc-like flashes in periphery"],
                            "condition": "Vitreous hemorrhage ?retinal tear",
                            "management": ["Same-day retinal examination", "Dilated fundoscopy", "May need surgery"]
                        }
                    ],
                    "urgent": [
                        {
                            "criteria": ["onset_timing:Within 24 hours", "risk_factors:High myopia (>-6D)"],
                            "condition": "Acute PVD high-risk patient",
                            "management": ["Urgent retinal exam <48h", "Dilated peripheral exam", "Counsel on RD symptoms"]
                        },
                        {
                            "criteria": ["onset_timing:Within 1 week", "floater_increase:Yes - few new floaters"],
                            "condition": "Recent PVD",
                            "management": ["Retinal exam within 1 week", "Check periphery", "Safety-net advice"]
                        }
                    ],
                    "routine": [
                        {
                            "criteria": ["onset_timing:Over 1 month ago", "visual_field:No", "vision_quality:Normal"],
                            "condition": "Chronic floaters",
                            "management": ["Routine ophthalmology", "Reassurance if PVD confirmed", "Annual screening if myopic"]
                        },
                        {
                            "criteria": ["flash_pattern:Zigzag patterns"],
                            "condition": "Migraine aura",
                            "management": ["Reassurance", "Migraine management", "Review if pattern changes"]
                        }
                    ]
                },
                "semiUrgent": [
                    {
                        "criteria": ["onset_timing:Within 1 month", "risk_factors:Previous retinal problems"],
                        "condition": "Recent symptoms in high-risk patient",
                        "management": ["Retinal exam within 2 weeks", "Thorough peripheral examination", "Document findings"]
                    }
                ],
                "defaultRules": {
                    "fieldBased": {
                        "visual_field:Yes - progressive": {
                            "condition": "Progressive field defect - retinal detachment until proven otherwise",
                            "urgency": "emergency",
                            "management": ["IMMEDIATE ophthalmology", "Keep nil by mouth", "Prepare for surgery"]
                        },
                        "visual_field:Yes - stable": {
                            "condition": "Stable field defect",
                            "urgency": "urgent",
                            "management": ["Urgent assessment same day", "May be old RD", "Document extent"]
                        }
                    },
                    "onsetBased": {
                        "onset_timing:Within 24 hours": {
                            "condition": "Acute vitreoretinal symptoms",
                            "urgency": "urgent",
                            "management": ["Dilated exam within 48h", "Higher risk period", "Clear safety-netting"]
                        },
                        "onset_timing:Within 1 week": {
                            "condition": "Recent onset symptoms",
                            "urgency": "urgent", 
                            "management": ["Exam within 1 week", "Risk of delayed tear", "Document symptoms"]
                        },
                        "onset_timing:Over 1 month ago": {
                            "condition": "Chronic symptoms",
                            "urgency": "routine",
                            "management": ["Routine assessment", "Lower risk", "Reassurance if stable"]
                        }
                    },
                    "riskBased": {
                        "risk_factors:High myopia (>-6D)": {
                            "condition": "High myope with symptoms",
                            "urgency": "urgent",
                            "management": ["Urgent assessment", "Higher RD risk", "Needs thorough peripheral exam"]
                        },
                        "risk_factors:Previous retinal problems": {
                            "condition": "Previous retinal pathology",
                            "urgency": "urgent",
                            "management": ["Urgent review", "Compare to previous", "Low threshold for treatment"]
                        },
                        "risk_factors:Recent eye surgery": {
                            "condition": "Post-operative symptoms",
                            "urgency": "urgent",
                            "management": ["Contact surgeon", "Same-day review", "Higher complication risk"]
                        }
                    }
                }
            },

            "Sudden Vision Loss": {
                "description": "Rapid assessment for acute vision loss - time-critical pathology",
                "pathways": ["Vascular", "Inflammatory", "Retinal", "Neurological"],
                "redFlags": [
                    "Complete vision loss",
                    "Giant cell arteritis symptoms",
                    "RAPD present",
                    "Cherry red spot",
                    "Pale swollen disc",
                    "Age >50 with headache"
                ],
                "questions": [
                    {
                        "id": "laterality",
                        "text": "Which eye(s) affected?",
                        "options": ["One eye (monocular)", "Both eyes (binocular)", "Unsure"],
                        "clinicalNote": "Monocular suggests ocular pathology; binocular suggests neurological"
                    },
                    {
                        "id": "onset_pattern",
                        "text": "Speed of vision loss?",
                        "options": ["Sudden (seconds)", "Rapid (minutes)", "Gradual (hours)", "Progressive (days)"],
                        "clinicalNote": "Instantaneous loss suggests vascular occlusion"
                    },
                    {
                        "id": "pain_present",
                        "text": "Is there associated pain?",
                        "options": ["No pain", "Mild discomfort", "Severe pain", "Pain on eye movement"],
                        "clinicalNote": "Painless loss often vascular; painful suggests inflammatory/glaucoma"
                    },
                    {
                        "id": "gca_symptoms",
                        "text": "Any GCA symptoms?",
                        "subtitle": "If age >50",
                        "options": ["Temporal headache", "Jaw claudication", "Scalp tenderness", "None", "Multiple symptoms"],
                        "clinicalNote": "GCA requires IMMEDIATE high-dose steroids to save vision"
                    },
                    {
                        "id": "visual_pattern",
                        "text": "Pattern of vision loss?",
                        "options": ["Complete blackout", "Central scotoma", "Altitudinal defect", "Curtain-like", "Patchy loss"],
                        "clinicalNote": "Pattern helps localize: altitudinal=AION, central=macular, curtain=amaurosis/RD"
                    },
                    {
                        "id": "duration",
                        "text": "Is vision loss persistent?",
                        "options": ["Not transient", "<5 minutes", "5-30 minutes", ">30 minutes", "Recurring episodes"],
                        "clinicalNote": "Transient loss (amaurosis fugax) predicts stroke risk"
                    }
                ],
                "triageLogic": {
                    "emergency": [
                        {
                            "criteria": ["gca_symptoms:Jaw claudication", "laterality:One eye (monocular)"],
                            "condition": "Giant cell arteritis",
                            "management": ["START prednisolone 60-80mg IMMEDIATELY", "Urgent ESR/CRP", "Temporal artery biopsy", "Protect fellow eye"]
                        },
                        {
                            "criteria": ["onset_pattern:Sudden (seconds)", "visual_pattern:Complete blackout", "pain_present:No pain"],
                            "condition": "Central retinal artery occlusion",
                            "management": ["IMMEDIATE ophthalmology", "Ocular massage", "Lower IOP", "Consider thrombolysis <4.5h"]
                        },
                        {
                            "criteria": ["visual_pattern:Altitudinal defect", "gca_symptoms:Multiple symptoms"],
                            "condition": "Arteritic AION",
                            "management": ["Immediate high-dose steroids", "Urgent ophthalmology", "Bilateral risk"]
                        }
                    ],
                    "urgent": [
                        {
                            "criteria": ["onset_pattern:Rapid (minutes)", "visual_pattern:Central scotoma"],
                            "condition": "Central retinal vein occlusion",
                            "management": ["Same-day ophthalmology", "Check IOP", "Cardiovascular risk factors"]
                        },
                        {
                            "criteria": ["pain_present:Pain on eye movement", "laterality:One eye (monocular)"],
                            "condition": "Optic neuritis",
                            "management": ["Urgent neurology/ophthalmology", "Consider MRI", "IV methylprednisolone"]
                        },
                        {
                            "criteria": ["duration:<5 minutes", "laterality:One eye (monocular)"],
                            "condition": "Amaurosis fugax",
                            "management": ["Urgent stroke workup", "Carotid imaging", "Start antiplatelet", "TIA clinic"]
                        }
                    ],
                    "routine": [
                        {
                            "criteria": ["onset_pattern:Progressive (days)", "pain_present:No pain"],
                            "condition": "Gradual vision loss",
                            "management": ["Ophthalmology within 1 week", "Check for cataract", "Macular assessment"]
                        }
                    ]
                },
                "semiUrgent": [
                    {
                        "criteria": ["laterality:Both eyes (binocular)", "visual_pattern:Patchy loss"],
                        "condition": "Bilateral visual disturbance",
                        "management": ["Urgent neurology", "Consider stroke", "Visual field testing"]
                    }
                ],
                "defaultRules": {
                    "gcaBased": {
                        "gca_symptoms:Jaw claudication": {
                            "condition": "Giant cell arteritis until proven otherwise",
                            "urgency": "emergency",
                            "management": ["Immediate prednisolone 60-80mg", "Do not delay for tests", "Urgent rheumatology"]
                        },
                        "gca_symptoms:Multiple symptoms": {
                            "condition": "Probable GCA",
                            "urgency": "emergency",
                            "management": ["Start steroids immediately", "Urgent inflammatory markers", "Temporal artery biopsy within 2 weeks"]
                        },
                        "gca_symptoms:Temporal headache": {
                            "condition": "Possible GCA",
                            "urgency": "urgent",
                            "management": ["Urgent ESR/CRP", "Low threshold for steroids", "Age >50 high risk"]
                        }
                    },
                    "patternBased": {
                        "visual_pattern:Complete blackout": {
                            "condition": "Total vision loss - vascular likely",
                            "urgency": "emergency",
                            "management": ["IMMEDIATE assessment", "Consider CRAO/CRVO", "Time-critical intervention"]
                        },
                        "visual_pattern:Altitudinal defect": {
                            "condition": "AION likely",
                            "urgency": "urgent",
                            "management": ["Same-day assessment", "Check for GCA", "Vascular risk factors"]
                        },
                        "visual_pattern:Central scotoma": {
                            "condition": "Macular pathology",
                            "urgency": "urgent",
                            "management": ["Urgent macular assessment", "OCT if available", "Consider CRVO/BRVO"]
                        },
                        "visual_pattern:Curtain-like": {
                            "condition": "Amaurosis fugax or RD",
                            "urgency": "urgent",
                            "management": ["Urgent assessment", "Carotid doppler if transient", "Dilated exam if persistent"]
                        }
                    },
                    "painBased": {
                        "pain_present:No pain": {
                            "condition": "Painless vision loss - vascular likely",
                            "urgency": "urgent",
                            "management": ["Urgent ophthalmology", "Vascular workup", "Consider embolic cause"]
                        },
                        "pain_present:Severe pain": {
                            "condition": "Painful vision loss",
                            "urgency": "urgent",
                            "management": ["Check IOP for angle closure", "Consider endophthalmitis", "Urgent assessment"]
                        },
                        "pain_present:Pain on eye movement": {
                            "condition": "Optic neuritis likely",
                            "urgency": "urgent",
                            "management": ["Neuro-ophthalmology", "MRI brain/orbits", "Consider MS"]
                        }
                    },
                    "onsetBased": {
                        "onset_pattern:Sudden (seconds)": {
                            "condition": "Acute vascular event",
                            "urgency": "emergency",
                            "management": ["IMMEDIATE assessment", "Consider CRAO", "Time-sensitive treatment"]
                        },
                        "onset_pattern:Progressive (days)": {
                            "condition": "Subacute vision loss",
                            "urgency": "routine",
                            "management": ["Ophthalmology within 1 week", "Full examination", "Consider reversible causes"]
                        }
                    },
                    "durationBased": {
                        "duration:Recurring episodes": {
                            "condition": "Recurrent transient vision loss",
                            "urgency": "urgent",
                            "management": ["High stroke risk", "Urgent vascular workup", "Antiplatelet therapy"]
                        },
                        "duration:<5 minutes": {
                            "condition": "Amaurosis fugax",
                            "urgency": "urgent",
                            "management": ["TIA clinic referral", "Carotid imaging", "Stroke prevention"]
                        }
                    }
                }
            },

            "Raised IOP": {
                "description": "Management pathway for elevated intraocular pressure",
                "pathways": ["Acute symptomatic", "Chronic asymptomatic", "Steroid-induced"],
                "redFlags": [
                    "IOP >35 mmHg",
                    "Corneal edema",
                    "Fixed dilated pupil",
                    "Severe pain with nausea",
                    "Visual halos"
                ],
                "questions": [
                    {
                        "id": "iop_level",
                        "text": "What is the IOP measurement?",
                        "subtitle": "If known - otherwise select symptoms",
                        "options": ["<21 mmHg", "21-30 mmHg", "31-40 mmHg", ">40 mmHg", "Not measured but symptomatic"],
                        "clinicalNote": "IOP >30 with symptoms requires urgent management"
                    },
                    {
                        "id": "symptoms",
                        "text": "Are there associated symptoms?",
                        "options": ["No symptoms", "Mild headache", "Severe pain + nausea", "Halos around lights", "Red eye"],
                        "clinicalNote": "Symptoms suggest acute angle closure requiring emergency treatment"
                    },
                    {
                        "id": "pupil_status",
                        "text": "Check pupil in affected eye",
                        "options": ["Normal reactive", "Sluggish", "Mid-dilated and fixed", "Not assessed"],
                        "clinicalNote": "Fixed mid-dilated pupil is pathognomonic for acute angle closure"
                    },
                    {
                        "id": "medication_history",
                        "text": "Current medications?",
                        "subtitle": "Particularly eye drops",
                        "options": ["No eye drops", "Steroid eye drops", "Glaucoma drops", "Recent dilating drops"],
                        "clinicalNote": "Steroid response can cause significant IOP elevation"
                    },
                    {
                        "id": "risk_assessment",
                        "text": "Risk factors present?",
                        "options": ["Hypermetropia", "Family history glaucoma", "Asian ethnicity", "Shallow anterior chamber", "None identified"],
                        "clinicalNote": "Multiple risk factors increase chance of angle closure"
                    }
                ],
                "triageLogic": {
                    "emergency": [
                        {
                            "criteria": ["symptoms:Severe pain + nausea", "pupil_status:Mid-dilated and fixed"],
                            "condition": "Acute angle closure glaucoma",
                            "management": ["IMMEDIATE referral", "IV acetazolamide", "Topical IOP lowering", "Analgesia/antiemetics"]
                        },
                        {
                            "criteria": ["iop_level:>40 mmHg", "symptoms:Red eye"],
                            "condition": "Hypertensive crisis",
                            "management": ["Urgent ophthalmology", "Start topical treatment", "Systemic acetazolamide"]
                        }
                    ],
                    "urgent": [
                        {
                            "criteria": ["iop_level:31-40 mmHg", "symptoms:No symptoms"],
                            "condition": "Ocular hypertension",
                            "management": ["Referral within 1 week", "Repeat IOP check", "Optic disc assessment"]
                        },
                        {
                            "criteria": ["medication_history:Steroid eye drops", "iop_level:21-30 mmHg"],
                            "condition": "Steroid response",
                            "management": ["Discuss with prescriber", "Consider stopping steroids", "IOP monitoring"]
                        }
                    ],
                    "routine": [
                        {
                            "criteria": ["iop_level:21-30 mmHg", "symptoms:No symptoms"],
                            "condition": "Borderline IOP",
                            "management": ["Glaucoma screening service", "Annual monitoring", "Risk factor modification"]
                        }
                    ]
                },
                // Default rules for undefined combinations
                "semiUrgent": [
                    {
                        "criteria": ["iop_level:31-40 mmHg", "symptoms:Mild headache"],
                        "condition": "Symptomatic ocular hypertension",
                        "management": ["Urgent ophthalmology within 48 hours", "Start topical treatment", "Check angles"]
                    }
                ],
                "defaultRules": {
                    "iopBased": {
                        "iop_level:>40 mmHg": {
                            "condition": "Severe ocular hypertension",
                            "urgency": "emergency",
                            "management": ["Emergency IOP reduction", "IV/oral acetazolamide", "Multiple topical agents"]
                        },
                        "iop_level:31-40 mmHg": {
                            "condition": "Moderate ocular hypertension",
                            "urgency": "urgent",
                            "management": ["Start topical IOP lowering", "Referral within 1 week", "Check for angle closure"]
                        },
                        "iop_level:21-30 mmHg": {
                            "condition": "Mild ocular hypertension",
                            "urgency": "routine",
                            "management": ["Glaucoma screening", "Risk stratification", "Consider treatment if risk factors"]
                        },
                        "iop_level:<21 mmHg": {
                            "condition": "Normal IOP with symptoms",
                            "urgency": "routine",
                            "management": ["Look for other causes", "Consider intermittent angle closure", "24-hour IOP monitoring"]
                        }
                    },
                    "symptomBased": {
                        "symptoms:Severe pain + nausea": {
                            "condition": "Acute glaucoma attack",
                            "urgency": "emergency",
                            "management": ["IMMEDIATE treatment", "Break attack urgently", "Bilateral PI needed"]
                        },
                        "symptoms:Halos around lights": {
                            "condition": "Intermittent angle closure",
                            "urgency": "urgent",
                            "management": ["Urgent gonioscopy", "Consider prophylactic PI", "Avoid dilating drops"]
                        },
                        "pupil_status:Mid-dilated and fixed": {
                            "condition": "Acute angle closure confirmed",
                            "urgency": "emergency",
                            "management": ["Emergency ophthalmology", "Medical treatment first", "Surgical intervention likely"]
                        }
                    }
                }
            },
            "Eyelid Problems": {
                "description": "Assessment for lid malposition, infection, and malignancy",
                "pathways": ["Infectious", "Mechanical", "Neoplastic", "Inflammatory"],
                "redFlags": [
                    "Orbital signs (proptosis, restricted movements)",
                    "Systemically unwell with lid swelling",
                    "Loss of eyelashes",
                    "Ulcerating lesion",
                    "Rapid growth"
                ],
                "questions": [
                    {
                        "id": "problem_type",
                        "text": "What is the primary lid problem?",
                        "options": ["Swelling", "Malposition", "Lump/lesion", "Redness/inflammation"],
                        "clinicalNote": "Different pathways for infectious vs mechanical problems"
                    },
                    {
                        "id": "swelling_extent",
                        "text": "If swelling, what is the extent?",
                        "options": ["Localized (stye/chalazion)", "Whole lid", "Lid + cheek", "Not applicable"],
                        "clinicalNote": "Extension beyond lid suggests orbital cellulitis"
                    },
                    {
                        "id": "systemic_features",
                        "text": "Any systemic features?",
                        "options": ["None", "Mild malaise", "Fever", "Systemically unwell"],
                        "clinicalNote": "Systemic features with lid swelling require admission"
                    },
                    {
                        "id": "eye_movement",
                        "text": "Are eye movements normal?",
                        "options": ["Normal", "Slightly restricted", "Significantly restricted", "Not tested"],
                        "clinicalNote": "Restricted movements indicate orbital involvement"
                    },
                    {
                        "id": "lesion_features",
                        "text": "If lesion present, describe features",
                        "options": ["Smooth, mobile", "Irregular edges", "Ulcerated", "Loss of lashes", "Not applicable"],
                        "clinicalNote": "Irregular/ulcerated lesions need urgent biopsy"
                    },
                    {
                        "id": "duration",
                        "text": "How long has problem been present?",
                        "options": ["<1 week", "1-4 weeks", "1-3 months", ">3 months"],
                        "clinicalNote": "Chronic lesions more likely benign but need assessment"
                    }
                ],
                "triageLogic": {
                    "emergency": [
                        {
                            "criteria": ["swelling_extent:Lid + cheek", "systemic_features:Systemically unwell", "eye_movement:Significantly restricted"],
                            "condition": "Orbital cellulitis",
                            "management": ["ADMIT immediately", "IV antibiotics", "CT scan", "ENT/ophthalmology review"]
                        }
                    ],
                    "urgent": [
                        {
                            "criteria": ["lesion_features:Ulcerated", "lesion_features:Loss of lashes"],
                            "condition": "Suspected malignancy",
                            "management": ["Urgent oculoplastics <2 weeks", "Photograph lesion", "No treatment until biopsy"]
                        },
                        {
                            "criteria": ["swelling_extent:Whole lid", "systemic_features:Fever"],
                            "condition": "Preseptal cellulitis",
                            "management": ["Oral antibiotics", "Daily review", "Mark extent", "Low threshold for admission"]
                        }
                    ],
                    "routine": [
                        {
                            "criteria": ["problem_type:Malposition", "duration:>3 months"],
                            "condition": "Ectropion/Entropion",
                            "management": ["Routine oculoplastics", "Lubricants", "Tape if needed"]
                        },
                        {
                            "criteria": ["swelling_extent:Localized (stye/chalazion)", "systemic_features:None"],
                            "condition": "Chalazion/Hordeolum",
                            "management": ["Warm compresses", "Lid hygiene", "Topical antibiotics if infected"]
                        }
                    ]
                },
                // Default rules for undefined combinations
                "semiUrgent": [
                    {
                        "criteria": ["swelling_extent:Whole lid", "systemic_features:Mild malaise"],
                        "condition": "Early preseptal cellulitis",
                        "management": ["Oral antibiotics", "Review in 24 hours", "Mark extent of erythema"]
                    },
                    {
                        "criteria": ["lesion_features:Irregular edges"],
                        "condition": "Suspicious lesion",
                        "management": ["Urgent oculoplastics <4 weeks", "Photograph lesion", "No treatment before assessment"]
                    }
                ],
                "defaultRules": {
                    "swellingBased": {
                        "swelling_extent:Lid + cheek": {
                            "condition": "Spreading cellulitis",
                            "urgency": "emergency",
                            "management": ["Admit for IV antibiotics", "CT scan to exclude orbital involvement", "Mark extent of erythema"]
                        },
                        "swelling_extent:Whole lid": {
                            "condition": "Preseptal cellulitis",
                            "urgency": "urgent",
                            "management": ["Oral co-amoxiclav", "Daily review", "Low threshold for admission"]
                        },
                        "swelling_extent:Localized (stye/chalazion)": {
                            "condition": "Localized lid infection",
                            "urgency": "routine",
                            "management": ["Warm compresses", "Lid hygiene", "Topical antibiotics if pointing"]
                        }
                    },
                    "lesionBased": {
                        "lesion_features:Ulcerated": {
                            "condition": "Suspected malignant lesion",
                            "urgency": "urgent",
                            "management": ["Urgent oculoplastics <2 weeks", "Photograph lesion", "No treatment before biopsy"]
                        },
                        "lesion_features:Loss of lashes": {
                            "condition": "Malignant lesion likely",
                            "urgency": "urgent",
                            "management": ["Urgent biopsy needed", "Document size and features", "Refer to oculoplastics"]
                        },
                        "problem_type:Malposition": {
                            "condition": "Lid malposition",
                            "urgency": "routine",
                            "management": ["Routine oculoplastics referral", "Lubricants for exposure", "Taping if symptomatic"]
                        }
                    },
                    "systemicBased": {
                        "systemic_features:Systemically unwell": {
                            "condition": "Severe infection",
                            "urgency": "emergency",
                            "management": ["Admit immediately", "IV antibiotics", "Investigate source"]
                        },
                        "eye_movement:Significantly restricted": {
                            "condition": "Orbital involvement",
                            "urgency": "emergency",
                            "management": ["Emergency admission", "CT orbits", "IV antibiotics"]
                        }
                    }
                }
            },
            "Watery Eyes": {
                "description": "Evaluation of epiphora - distinguishing reflex from obstructive causes",
                "pathways": ["Reflex tearing", "Lacrimal obstruction", "Lid malposition"],
                "redFlags": [
                    "Associated with lid swelling",
                    "Bloody tears",
                    "Recurrent infections",
                    "Facial nerve palsy"
                ],
                "questions": [
                    {
                        "id": "associated_symptoms",
                        "text": "Are there other eye symptoms?",
                        "options": ["No - just watering", "Irritation/grittiness", "Redness", "Discharge"],
                        "clinicalNote": "Associated symptoms suggest reflex tearing from ocular surface disease"
                    },
                    {
                        "id": "laterality",
                        "text": "Which eye(s) affected?",
                        "options": ["One eye", "Both eyes equally", "Both but one worse"],
                        "clinicalNote": "Unilateral suggests obstruction; bilateral suggests reflex cause"
                    },
                    {
                        "id": "timing",
                        "text": "When is watering worst?",
                        "options": ["Constant", "Outdoors/wind", "Reading/computer", "Morning only"],
                        "clinicalNote": "Environmental triggers suggest reflex tearing"
                    },
                    {
                        "id": "lid_position",
                        "text": "Are the eyelids in normal position?",
                        "options": ["Yes", "Lower lid turning out", "Lower lid turning in", "Facial weakness"],
                        "clinicalNote": "Lid malposition prevents proper tear drainage"
                    },
                    {
                        "id": "previous_episodes",
                        "text": "Any history of lid infections?",
                        "options": ["No", "Occasional styes", "Recurrent infections", "Dacryocystitis"],
                        "clinicalNote": "Recurrent infections suggest nasolacrimal obstruction"
                    }
                ],
                "triageLogic": {
                    "urgent": [
                        {
                            "criteria": ["previous_episodes:Dacryocystitis", "associated_symptoms:Discharge"],
                            "condition": "Acute dacryocystitis",
                            "management": ["Oral antibiotics", "Warm compresses", "ENT/oculoplastics referral"]
                        }
                    ],
                    "routine": [
                        {
                            "criteria": ["lid_position:Lower lid turning out"],
                            "condition": "Ectropion",
                            "management": ["Lubricants", "Taping at night", "Oculoplastics referral"]
                        },
                        {
                            "criteria": ["associated_symptoms:No - just watering", "timing:Constant"],
                            "condition": "Nasolacrimal obstruction",
                            "management": ["Routine oculoplastics", "Consider DCR", "Manage expectations"]
                        },
                        {
                            "criteria": ["associated_symptoms:Irritation/grittiness", "timing:Reading/computer"],
                            "condition": "Dry eye paradoxical tearing",
                            "management": ["Preservative-free lubricants", "Lid hygiene", "Environmental advice"]
                        }
                    ]
                },
                // Default rules for undefined combinations
                "semiUrgent": [
                    {
                        "criteria": ["associated_symptoms:Redness"],
                        "condition": "Inflammatory epiphora",
                        "management": ["Treat underlying inflammation", "Lubricants", "Review in 1 week"]
                    }
                ],
                "defaultRules": {
                    "symptomBased": {
                        "associated_symptoms:Discharge": {
                            "condition": "Infective dacryocystitis",
                            "urgency": "urgent",
                            "management": ["Oral antibiotics", "Warm compresses", "Consider DCR after acute phase"]
                        },
                        "associated_symptoms:No - just watering": {
                            "condition": "Primary epiphora",
                            "urgency": "routine",
                            "management": ["Lacrimal syringing", "Consider DCR if obstructed", "Conservative management initially"]
                        },
                        "associated_symptoms:Irritation/grittiness": {
                            "condition": "Reflex tearing from dry eye",
                            "urgency": "routine",
                            "management": ["Preservative-free lubricants", "Treat underlying dry eye", "Lid hygiene"]
                        }
                    },
                    "lidBased": {
                        "lid_position:Lower lid turning out": {
                            "condition": "Ectropion with epiphora",
                            "urgency": "routine",
                            "management": ["Lubricants", "Lid taping", "Surgical correction if persistent"]
                        },
                        "lid_position:Lower lid turning in": {
                            "condition": "Entropion with tearing",
                            "urgency": "urgent",
                            "management": ["Urgent correction needed", "Tape lid as temporary measure", "Risk of corneal damage"]
                        },
                        "lid_position:Facial weakness": {
                            "condition": "Facial palsy with exposure",
                            "urgency": "urgent",
                            "management": ["Intensive lubrication", "Consider tarsorrhaphy", "Investigate cause of palsy"]
                        }
                    },
                    "lateralityBased": {
                        "laterality:One eye": {
                            "condition": "Unilateral epiphora - likely obstruction",
                            "urgency": "routine",
                            "management": ["Syringe and probe", "Consider DCR", "Rule out malignancy if elderly"]
                        },
                        "laterality:Both eyes equally": {
                            "condition": "Bilateral epiphora - likely reflex",
                            "urgency": "routine",
                            "management": ["Treat ocular surface", "Environmental modifications", "Lubricants"]
                        }
                    }
                }
            },
            "Pediatric Eye Problems": {
                "description": "Age-appropriate assessment for children's eye conditions",
                "pathways": ["Infant (<1yr)", "Toddler (1-3yr)", "School age (4-10yr)"],
                "redFlags": [
                    "White pupil (leukocoria)",
                    "Cloudy cornea",
                    "Nystagmus",
                    "Not fixing/following by 3 months",
                    "Asymmetric red reflex"
                ],
                "questions": [
                    {
                        "id": "age_group",
                        "text": "What is the child's age?",
                        "options": ["0-6 months", "6-12 months", "1-3 years", "3-8 years", ">8 years"],
                        "clinicalNote": "Age determines urgency and referral pathway"
                    },
                    {
                        "id": "presenting_problem",
                        "text": "What is the main concern?",
                        "options": ["Squint/misalignment", "Red/sticky eye", "Poor vision", "Abnormal appearance", "Watery eye"],
                        "clinicalNote": "Different conditions have age-specific implications"
                    },
                    {
                        "id": "red_reflex",
                        "text": "Is red reflex normal?",
                        "subtitle": "If checked",
                        "options": ["Normal both eyes", "Absent/white", "Asymmetric", "Not checked"],
                        "clinicalNote": "Abnormal red reflex requires URGENT referral"
                    },
                    {
                        "id": "onset_timing",
                        "text": "When was problem first noticed?",
                        "options": ["Since birth", "Recent weeks", "Recent months", "Intermittent"],
                        "clinicalNote": "Congenital problems may need earlier intervention"
                    },
                    {
                        "id": "development",
                        "text": "Are developmental milestones normal?",
                        "options": ["Yes", "Delayed", "Regression", "Not sure"],
                        "clinicalNote": "Developmental issues may indicate syndromic conditions"
                    },
                    {
                        "id": "family_history",
                        "text": "Relevant family history?",
                        "options": ["None", "Squint", "Lazy eye", "Childhood cataracts", "Retinoblastoma"],
                        "clinicalNote": "Family history affects urgency and screening needs"
                    }
                ],
                "triageLogic": {
                    "emergency": [
                        {
                            "criteria": ["red_reflex:Absent/white"],
                            "condition": "Leukocoria - ?retinoblastoma",
                            "management": ["URGENT pediatric ophthalmology", "Within 2 weeks maximum", "Photograph if possible"]
                        },
                        {
                            "criteria": ["presenting_problem:Abnormal appearance", "age_group:0-6 months"],
                            "condition": "Congenital cataract/glaucoma",
                            "management": ["Urgent referral", "Risk of irreversible amblyopia", "Consider systemic associations"]
                        }
                    ],
                    "urgent": [
                        {
                            "criteria": ["presenting_problem:Squint/misalignment", "age_group:0-6 months"],
                            "condition": "Infantile esotropia",
                            "management": ["Pediatric ophthalmology", "Within 4-6 weeks", "Early surgery may be needed"]
                        },
                        {
                            "criteria": ["presenting_problem:Red/sticky eye", "age_group:0-6 months", "onset_timing:Since birth"],
                            "condition": "Neonatal conjunctivitis",
                            "management": ["Urgent pediatrics", "Swabs for chlamydia/gonorrhea", "Systemic treatment needed"]
                        }
                    ],
                    "routine": [
                        {
                            "criteria": ["presenting_problem:Squint/misalignment", "age_group:3-8 years"],
                            "condition": "Childhood squint",
                            "management": ["Orthoptic assessment", "Check vision both eyes", "Glasses if needed"]
                        },
                        {
                            "criteria": ["presenting_problem:Watery eye", "onset_timing:Since birth"],
                            "condition": "Nasolacrimal duct obstruction",
                            "management": ["Massage technique", "Usually resolves by 1 year", "Probe if persistent"]
                        }
                    ]
                },
                // Default rules for undefined combinations
                "semiUrgent": [
                    {
                        "criteria": ["red_reflex:Asymmetric"],
                        "condition": "Asymmetric red reflex requiring investigation",
                        "management": ["Urgent pediatric ophthalmology", "Within 2-4 weeks", "Rule out media opacity"]
                    },
                    {
                        "criteria": ["presenting_problem:Poor vision", "age_group:1-3 years"],
                        "condition": "Toddler vision concerns",
                        "management": ["Pediatric assessment within 4 weeks", "Check for refractive error", "Risk of amblyopia"]
                    }
                ],
                "defaultRules": {
                    "reflexBased": {
                        "red_reflex:Absent/white": {
                            "condition": "Leukocoria - urgent investigation needed",
                            "urgency": "emergency",
                            "management": ["URGENT pediatric ophthalmology within 2 weeks", "Rule out retinoblastoma", "Full examination under anesthesia"]
                        },
                        "red_reflex:Asymmetric": {
                            "condition": "Asymmetric red reflex",
                            "urgency": "urgent",
                            "management": ["Urgent pediatric ophthalmology", "Rule out cataract/tumor", "Dilated examination needed"]
                        },
                        "red_reflex:Not checked": {
                            "condition": "Red reflex not assessed",
                            "urgency": "urgent",
                            "management": ["Must check red reflex urgently", "Refer if unable to assess", "Critical screening test"]
                        }
                    },
                    "ageBased": {
                        "age_group:0-6 months": {
                            "condition": "Infant eye problem - critical period",
                            "urgency": "urgent",
                            "management": ["Pediatric ophthalmology within 2-4 weeks", "Risk of amblyopia", "Early intervention crucial"]
                        },
                        "age_group:6-12 months": {
                            "condition": "Late infant concern",
                            "urgency": "urgent",
                            "management": ["Assessment within 4-6 weeks", "Check developmental milestones", "Amblyopia risk"]
                        },
                        "age_group:1-3 years": {
                            "condition": "Toddler eye problem",
                            "urgency": "routine",
                            "management": ["Pediatric assessment within 8 weeks", "Vision screening", "Consider glasses"]
                        }
                    },
                    "problemBased": {
                        "presenting_problem:Poor vision": {
                            "condition": "Childhood vision loss",
                            "urgency": "urgent",
                            "management": ["Urgent pediatric assessment", "Check for refractive error", "Rule out pathology"]
                        },
                        "presenting_problem:Abnormal appearance": {
                            "condition": "Structural abnormality",
                            "urgency": "urgent",
                            "management": ["Urgent assessment needed", "Rule out congenital anomalies", "May need imaging"]
                        },
                        "presenting_problem:Squint/misalignment": {
                            "condition": "Childhood strabismus",
                            "urgency": "routine",
                            "management": ["Orthoptic assessment", "Amblyopia prevention", "May need surgery"]
                        }
                    }
                }
            },
            "Diplopia": {
                "description": "Double vision assessment - distinguishing neurological from mechanical causes",
                "pathways": ["Monocular", "Binocular", "Variable"],
                "redFlags": [
                    "Pupil involvement (CN III)",
                    "Multiple cranial nerves",
                    "Progressive symptoms",
                    "Age >50 with acute onset",
                    "Associated neurological signs"
                ],
                "questions": [
                    {
                        "id": "type",
                        "text": "Is diplopia monocular or binocular?",
                        "subtitle": "Does it resolve when covering one eye?",
                        "options": ["Resolves with one eye covered (binocular)", "Persists with one eye (monocular)", "Variable", "Unsure"],
                        "clinicalNote": "Monocular diplopia is usually refractive; binocular suggests muscle/nerve pathology"
                    },
                    {
                        "id": "onset",
                        "text": "How did symptoms begin?",
                        "options": ["Sudden onset", "Gradual over days", "Progressive over weeks", "Long-standing"],
                        "clinicalNote": "Sudden onset in older patients needs urgent assessment for stroke"
                    },
                    {
                        "id": "pattern",
                        "text": "When is diplopia worst?",
                        "options": ["Constant", "Distance only", "Near only", "Varies through day", "Certain directions"],
                        "clinicalNote": "Variable symptoms suggest myasthenia gravis"
                    },
                    {
                        "id": "associated_features",
                        "text": "Associated symptoms?",
                        "options": ["None", "Headache", "Ptosis", "Facial weakness", "Pupil abnormality"],
                        "clinicalNote": "Multiple features suggest serious neurological pathology"
                    },
                    {
                        "id": "risk_factors",
                        "text": "Relevant history?",
                        "options": ["None", "Diabetes", "Hypertension", "Recent trauma", "Thyroid disease"],
                        "clinicalNote": "Vascular risk factors common in isolated CN VI palsy"
                    }
                ],
                "triageLogic": {
                    "emergency": [
                        {
                            "criteria": ["associated_features:Pupil abnormality", "onset:Sudden onset"],
                            "condition": "CN III palsy with pupil involvement",
                            "management": ["IMMEDIATE neurology", "?Aneurysm", "Urgent neuroimaging"]
                        },
                        {
                            "criteria": ["associated_features:Facial weakness", "pattern:Varies through day"],
                            "condition": "Myasthenia gravis",
                            "management": ["Urgent neurology", "Tensilon test", "Check breathing"]
                        }
                    ],
                    "urgent": [
                        {
                            "criteria": ["type:Resolves with one eye covered (binocular)", "onset:Sudden onset", "risk_factors:None"],
                            "condition": "Isolated cranial nerve palsy",
                            "management": ["Neuro-ophthalmology <1 week", "Consider imaging", "Exclude GCA if >50"]
                        }
                    ],
                    "routine": [
                        {
                            "criteria": ["type:Persists with one eye (monocular)"],
                            "condition": "Monocular diplopia",
                            "management": ["Refraction", "Check for cataract", "Routine ophthalmology"]
                        },
                        {
                            "criteria": ["onset:Long-standing", "pattern:Certain directions"],
                            "condition": "Chronic stable diplopia",
                            "management": ["Orthoptic assessment", "Prisms if needed", "Consider surgery"]
                        }
                    ]
                },
                // Default rules for undefined combinations
                "semiUrgent": [
                    {
                        "criteria": ["pattern:Distance only"],
                        "condition": "Distance diplopia",
                        "management": ["Check for decompensated phoria", "Prism assessment", "Consider orthoptic exercises"]
                    }
                ],
                "defaultRules": {
                    "typeBased": {
                        "type:Resolves with one eye covered (binocular)": {
                            "condition": "Binocular diplopia - neurological cause",
                            "urgency": "urgent",
                            "management": ["Neuro-ophthalmology assessment", "Consider MRI", "Check for systemic causes"]
                        },
                        "type:Persists with one eye (monocular)": {
                            "condition": "Monocular diplopia - optical cause",
                            "urgency": "routine",
                            "management": ["Refraction", "Check for cataract", "Consider corneal irregularity"]
                        },
                        "type:Variable": {
                            "condition": "Variable diplopia - consider myasthenia",
                            "urgency": "urgent",
                            "management": ["Urgent neurology", "Fatigability testing", "Acetylcholine receptor antibodies"]
                        }
                    },
                    "featureBased": {
                        "associated_features:Pupil abnormality": {
                            "condition": "Third nerve palsy",
                            "urgency": "emergency",
                            "management": ["URGENT neuroimaging", "Rule out aneurysm", "Neurosurgical consultation"]
                        },
                        "associated_features:Ptosis": {
                            "condition": "Ptosis with diplopia",
                            "urgency": "urgent",
                            "management": ["Consider myasthenia or CN III", "Urgent assessment", "May need Tensilon test"]
                        },
                        "associated_features:Facial weakness": {
                            "condition": "Multiple cranial nerve involvement",
                            "urgency": "emergency",
                            "management": ["Emergency neurology", "MRI brain", "Consider brainstem pathology"]
                        }
                    },
                    "onsetBased": {
                        "onset:Sudden onset": {
                            "condition": "Acute cranial nerve palsy",
                            "urgency": "urgent",
                            "management": ["Urgent assessment", "Vascular workup", "Consider GCA if >50"]
                        },
                        "onset:Long-standing": {
                            "condition": "Chronic stable diplopia",
                            "urgency": "routine",
                            "management": ["Orthoptic assessment", "Prism options", "Consider surgery if stable"]
                        },
                        "pattern:Varies through day": {
                            "condition": "Variable diplopia - ?myasthenia",
                            "urgency": "urgent",
                            "management": ["Neurology referral", "Acetylcholine receptor antibodies", "Consider Tensilon test"]
                        }
                    }
                }
            },
            "Headaches with Visual Symptoms": {
                "description": "Differentiating primary headaches from sight/life-threatening causes",
                "pathways": ["Migraine", "Raised ICP", "Vascular", "Ocular"],
                "redFlags": [
                    "Papilledema",
                    "New headache pattern >50 years",
                    "Worse on waking/valsalva",
                    "Progressive visual loss",
                    "Neurological signs"
                ],
                "questions": [
                    {
                        "id": "visual_symptoms",
                        "text": "What visual symptoms occur?",
                        "options": ["Zigzag lines/fortification", "Transient vision loss", "Persistent blur", "Double vision", "Visual field defect"],
                        "clinicalNote": "Classic migraine has positive phenomena; concerning if negative symptoms"
                    },
                    {
                        "id": "headache_pattern",
                        "text": "Describe headache pattern",
                        "options": ["Classic migraine", "Worse on waking", "Sudden severe", "Progressive worsening", "With eye movement"],
                        "clinicalNote": "Morning headaches and progression suggest raised ICP"
                    },
                    {
                        "id": "fundoscopy",
                        "text": "Fundoscopy findings?",
                        "subtitle": "If examined",
                        "options": ["Normal", "Disc swelling", "Disc pallor", "Not examined"],
                        "clinicalNote": "Papilledema requires URGENT investigation"
                    },
                    {
                        "id": "age_symptoms",
                        "text": "Age and symptom duration?",
                        "options": ["<50 years, familiar pattern", ">50 years, new pattern", "Any age, progressive", "Any age, sudden onset"],
                        "clinicalNote": "New headaches after 50 need investigation for GCA/masses"
                    },
                    {
                        "id": "associated_features",
                        "text": "Other features present?",
                        "options": ["Nausea only", "Jaw claudication", "Scalp tenderness", "Red painful eye", "None"],
                        "clinicalNote": "GCA features require immediate treatment"
                    }
                ],
                "triageLogic": {
                    "emergency": [
                        {
                            "criteria": ["fundoscopy:Disc swelling", "headache_pattern:Worse on waking"],
                            "condition": "Papilledema - raised ICP",
                            "management": ["URGENT medical admission", "CT/MRI brain", "Neurology review", "LP if safe"]
                        },
                        {
                            "criteria": ["associated_features:Jaw claudication", "age_symptoms:>50 years, new pattern"],
                            "condition": "Giant cell arteritis",
                            "management": ["Immediate prednisolone 60-80mg", "ESR/CRP urgent", "Temporal artery biopsy"]
                        },
                        {
                            "criteria": ["associated_features:Red painful eye", "visual_symptoms:Persistent blur"],
                            "condition": "Acute angle closure",
                            "management": ["Check IOP urgently", "Emergency ophthalmology", "IV/oral acetazolamide"]
                        }
                    ],
                    "urgent": [
                        {
                            "criteria": ["visual_symptoms:Double vision", "headache_pattern:Progressive worsening"],
                            "condition": "Compressive lesion",
                            "management": ["Urgent neuroimaging", "Neurology referral", "Document progression"]
                        }
                    ],
                    "routine": [
                        {
                            "criteria": ["visual_symptoms:Zigzag lines/fortification", "age_symptoms:<50 years, familiar pattern"],
                            "condition": "Migraine with aura",
                            "management": ["Migraine diary", "Trigger avoidance", "Prophylaxis if frequent", "GP management"]
                        }
                    ]
                },
                // Default rules for undefined combinations
                "semiUrgent": [
                    {
                        "criteria": ["visual_symptoms:Transient vision loss"],
                        "condition": "Transient visual obscuration",
                        "management": ["Check for papilledema", "Consider raised ICP", "Urgent neurology if recurrent"]
                    }
                ],
                "defaultRules": {
                    "fundoscopyBased": {
                        "fundoscopy:Disc swelling": {
                            "condition": "Papilledema - raised ICP",
                            "urgency": "emergency",
                            "management": ["URGENT medical admission", "Neuroimaging", "LP if safe", "Neurology consultation"]
                        },
                        "fundoscopy:Disc pallor": {
                            "condition": "Optic atrophy",
                            "urgency": "urgent",
                            "management": ["Urgent neurology", "MRI brain and orbits", "Investigate cause"]
                        },
                        "fundoscopy:Not examined": {
                            "condition": "Fundoscopy essential",
                            "urgency": "urgent",
                            "management": ["Must examine optic discs", "Refer if unable", "Critical for diagnosis"]
                        }
                    },
                    "patternBased": {
                        "headache_pattern:Sudden severe": {
                            "condition": "Thunderclap headache",
                            "urgency": "emergency",
                            "management": ["Emergency department", "CT head", "Rule out SAH"]
                        },
                        "headache_pattern:Progressive worsening": {
                            "condition": "Progressive headache syndrome",
                            "urgency": "urgent",
                            "management": ["Urgent neuroimaging", "Check for mass lesion", "Neurology referral"]
                        },
                        "headache_pattern:Worse on waking": {
                            "condition": "Raised ICP pattern",
                            "urgency": "urgent",
                            "management": ["Urgent investigation", "Check optic discs", "MRI brain"]
                        }
                    },
                    "ageBased": {
                        "age_symptoms:>50 years, new pattern": {
                            "condition": "New headache over 50",
                            "urgency": "urgent",
                            "management": ["ESR/CRP urgently", "Consider GCA", "Low threshold for treatment"]
                        },
                        "age_symptoms:<50 years, familiar pattern": {
                            "condition": "Primary headache disorder",
                            "urgency": "routine",
                            "management": ["Headache diary", "Lifestyle advice", "Prophylaxis if frequent"]
                        }
                    },
                    "visualBased": {
                        "visual_symptoms:Visual field defect": {
                            "condition": "Neurological field defect",
                            "urgency": "urgent",
                            "management": ["Urgent neuroimaging", "Map field defect", "Neurology assessment"]
                        },
                        "visual_symptoms:Double vision": {
                            "condition": "Diplopia with headache",
                            "urgency": "urgent",
                            "management": ["Check cranial nerves", "Consider raised ICP", "MRI brain"]
                        }
                    }
                }
            },
            "Corneal Problems": {
                "description": "Assessment of corneal pathology including trauma, infection, and dystrophies",
                "pathways": ["Traumatic", "Infectious", "Inflammatory", "Degenerative"],
                "redFlags": [
                    "Contact lens wearer with pain",
                    "Penetrating injury suspicion",
                    "Dendritic ulcer pattern",
                    "Central corneal involvement",
                    "Hypopyon"
                ],
                "questions": [
                    {
                        "id": "precipitating_event",
                        "text": "Was there a precipitating event?",
                        "options": ["Trauma/injury", "Foreign body", "Chemical exposure", "No specific event"],
                        "clinicalNote": "Chemical injuries need immediate irrigation before assessment"
                    },
                    {
                        "id": "contact_lens_user",
                        "text": "Does patient wear contact lenses?",
                        "options": ["Yes - current user", "Yes - but not recently", "No", "Overnight wear"],
                        "clinicalNote": "Contact lens keratitis can progress rapidly and needs different treatment"
                    },
                    {
                        "id": "pain_level",
                        "text": "Severity of pain?",
                        "options": ["No pain", "Mild discomfort", "Moderate pain", "Severe pain"],
                        "clinicalNote": "Severe pain with contact lens use suggests microbial keratitis"
                    },
                    {
                        "id": "vision_impact",
                        "text": "Is vision affected?",
                        "options": ["No change", "Slight blur", "Significant reduction", "Can't see details"],
                        "clinicalNote": "Vision loss suggests central corneal involvement"
                    },
                    {
                        "id": "fluorescein_pattern",
                        "text": "Fluorescein staining pattern?",
                        "subtitle": "If available",
                        "options": ["No uptake", "Linear abrasion", "Punctate staining", "Dendritic pattern", "Large epithelial defect", "Not tested"],
                        "clinicalNote": "Dendritic = HSV keratitis; Geographic = healing/treated HSV"
                    },
                    {
                        "id": "associated_features",
                        "text": "Other features present?",
                        "options": ["White infiltrate", "Hypopyon", "Corneal thinning", "None visible"],
                        "clinicalNote": "Infiltrates and hypopyon indicate severe infection"
                    }
                ],
                "triageLogic": {
                    "emergency": [
                        {
                            "criteria": ["precipitating_event:Chemical exposure"],
                            "condition": "Chemical burn",
                            "management": ["IMMEDIATE irrigation", "Check pH", "Continue until pH 7.0", "Then urgent ophthalmology"]
                        },
                        {
                            "criteria": ["contact_lens_user:Yes - current user", "associated_features:Hypopyon"],
                            "condition": "Severe microbial keratitis",
                            "management": ["URGENT ophthalmology", "Corneal scrape before antibiotics", "Intensive topical therapy"]
                        }
                    ],
                    "urgent": [
                        {
                            "criteria": ["fluorescein_pattern:Dendritic pattern"],
                            "condition": "Herpetic keratitis",
                            "management": ["Same-day ophthalmology", "Antiviral therapy", "NO steroids without supervision"]
                        },
                        {
                            "criteria": ["contact_lens_user:Yes - current user", "pain_level:Severe pain", "vision_impact:Significant reduction"],
                            "condition": "Contact lens keratitis",
                            "management": ["Stop lens wear immediately", "Same-day referral", "Broad spectrum antibiotics"]
                        },
                        {
                            "criteria": ["precipitating_event:Trauma/injury", "fluorescein_pattern:Large epithelial defect"],
                            "condition": "Significant corneal abrasion",
                            "management": ["Rule out perforation", "Prophylactic antibiotics", "Close follow-up needed"]
                        }
                    ],
                    "routine": [
                        {
                            "criteria": ["fluorescein_pattern:Linear abrasion", "contact_lens_user:No"],
                            "condition": "Simple corneal abrasion",
                            "management": ["Chloramphenicol QDS", "Oral analgesia", "Review 24-48h if not improving"]
                        },
                        {
                            "criteria": ["fluorescein_pattern:Punctate staining", "pain_level:Mild discomfort"],
                            "condition": "Superficial punctate keratopathy",
                            "management": ["Preservative-free lubricants", "Treat underlying cause", "Review if worsening"]
                        }
                    ]
                },
                // Default rules for undefined combinations
                "semiUrgent": [
                    {
                        "criteria": ["contact_lens_user:Yes - but not recently", "pain_level:Moderate pain"],
                        "condition": "Previous CL user with keratitis",
                        "management": ["Same-day assessment", "Consider bacterial keratitis", "Broad spectrum antibiotics"]
                    },
                    {
                        "criteria": ["vision_impact:Slight blur", "fluorescein_pattern:Punctate staining"],
                        "condition": "Superficial keratopathy",
                        "management": ["Lubricants hourly", "Review in 48h", "Investigate cause"]
                    }
                ],
                "defaultRules": {
                    "eventBased": {
                        "precipitating_event:Chemical exposure": {
                            "condition": "Chemical injury",
                            "urgency": "emergency",
                            "management": ["IMMEDIATE irrigation for 30 minutes", "Check pH", "Continue until neutral", "Then urgent ophthalmology"]
                        },
                        "precipitating_event:Trauma/injury": {
                            "condition": "Traumatic corneal injury",
                            "urgency": "urgent",
                            "management": ["Rule out perforation", "Seidel test", "Protective shield if suspicious", "Same-day ophthalmology"]
                        },
                        "precipitating_event:Foreign body": {
                            "condition": "Corneal foreign body",
                            "urgency": "urgent",
                            "management": ["Remove if superficial", "Rust ring needs ophthalmology", "Prophylactic antibiotics"]
                        }
                    },
                    "contactLensBased": {
                        "contact_lens_user:Yes - current user": {
                            "condition": "Contact lens-related keratitis risk",
                            "urgency": "urgent",
                            "management": ["Stop lens wear immediately", "Same-day assessment", "Scrape before antibiotics if infiltrate"]
                        },
                        "contact_lens_user:Overnight wear": {
                            "condition": "High-risk CL keratitis",
                            "urgency": "urgent",
                            "management": ["Stop all lens wear", "Urgent ophthalmology", "High risk of severe infection"]
                        }
                    },
                    "stainBased": {
                        "fluorescein_pattern:Dendritic pattern": {
                            "condition": "Herpetic keratitis",
                            "urgency": "urgent",
                            "management": ["Same-day ophthalmology", "Antiviral therapy", "NEVER give steroids without supervision"]
                        },
                        "fluorescein_pattern:Large epithelial defect": {
                            "condition": "Large corneal abrasion/ulcer",
                            "urgency": "urgent",
                            "management": ["Rule out perforation", "Bandage contact lens consideration", "Intensive antibiotics"]
                        },
                        "fluorescein_pattern:No uptake": {
                            "condition": "No epithelial defect",
                            "urgency": "routine",
                            "management": ["Consider other causes of pain", "Lubricants", "Review if persists"]
                        }
                    },
                    "visionBased": {
                        "vision_impact:Can't see details": {
                            "condition": "Central corneal pathology",
                            "urgency": "urgent",
                            "management": ["Same-day ophthalmology", "Document visual acuity", "Protect eye"]
                        },
                        "vision_impact:Significant reduction": {
                            "condition": "Vision-threatening keratitis",
                            "urgency": "urgent",
                            "management": ["Urgent referral same day", "Start treatment", "Document findings"]
                        }
                    },
                    "featureBased": {
                        "associated_features:Hypopyon": {
                            "condition": "Severe keratitis with hypopyon",
                            "urgency": "emergency",
                            "management": ["IMMEDIATE ophthalmology", "Intensive fortified antibiotics", "Consider admission"]
                        },
                        "associated_features:White infiltrate": {
                            "condition": "Infiltrative keratitis",
                            "urgency": "urgent",
                            "management": ["Same-day referral", "Scrape before treatment", "Intensive therapy needed"]
                        }
                    }
                }
            }
        };

        // Add this helper function for enhanced default rules
        function applyEnhancedDefaultRules(schema, responses, severityScore, scoreBasedUrgency) {
            let bestMatch = null;
            let highestPriority = -1;
            
            // Define priority for different rule categories
            const rulePriority = {
                'visionBased': 10,
                'symptomBased': 9,
                'riskBased': 8,
                'fieldBased': 10,
                'gcaBased': 10,
                'patternBased': 9,
                'onsetBased': 7,
                'painBased': 8,
                'reflexBased': 10,
                'ageBased': 6,
                'typeBased': 8,
                'featureBased': 9,
                'fundoscopyBased': 10,
                'swellingBased': 8,
                'lesionBased': 9,
                'systemicBased': 10,
                'iopBased': 9,
                'lidBased': 7,
                'lateralityBased': 6,
                'eventBased': 9,
                'contactLensBased': 9,
                'stainBased': 9,
                'durationBased': 6,
                'problemBased': 7
            };
            
            // Check all default rule categories
            for (const [category, rules] of Object.entries(schema.defaultRules)) {
                const priority = rulePriority[category] || 5;
                
                for (const [criterion, ruleData] of Object.entries(rules)) {
                    const [questionId, expectedAnswer] = criterion.split(':');
                    
                    if (responses[questionId] === expectedAnswer) {
                        if (priority > highestPriority) {
                            highestPriority = priority;
                            bestMatch = {
                                urgency: ruleData.urgency || scoreBasedUrgency || 'urgent',
                                condition: ruleData.condition,
                                reasoning: `Based on ${questionId.replace(/_/g, ' ')}: ${expectedAnswer}. ${ruleData.condition}. Severity score: ${severityScore}.`,
                                management: ruleData.management,
                                referralTimeframe: getTimeframeForUrgency(ruleData.urgency || scoreBasedUrgency || 'urgent'),
                                severityScore: severityScore
                            };
                        }
                    }
                }
            }
            
            return bestMatch;
        }

        // Function to generate clinical notes for GOS18
        function generateClinicalNotes(condition, urgency, responses) {
            if (clinicalNotesTemplates[condition] && clinicalNotesTemplates[condition][urgency]) {
                return clinicalNotesTemplates[condition][urgency](responses);
            }
            
            // Fallback for other conditions
            return `${condition} - ${urgency} referral. See assessment details above.`;
        }

        // Enhanced function to populate GOS18 form
        function populateGOS18Form() {
            if (!recommendation) return;
            
            const clinicalFindingsTextarea = document.getElementById('gos18-clinical-findings');
            const urgencyCheckboxes = {
                'emergency': document.getElementById('referralOcular'),
                'urgent': document.getElementById('referralSemi'),
                'routine': document.getElementById('referralRoutine')
            };
            
            // Generate and set clinical notes
            const clinicalNotes = generateClinicalNotes(selectedCondition, recommendation.urgency, responses);
            if (clinicalFindingsTextarea) {
                clinicalFindingsTextarea.value = clinicalNotes;
            }
            
            // Check appropriate urgency box
            const urgencyCheckbox = urgencyCheckboxes[recommendation.urgency];
            if (urgencyCheckbox) {
                urgencyCheckbox.checked = true;
            }
            
            // Set today's date
            const referralDateInput = document.getElementById('referralDate');
            if (referralDateInput) {
                referralDateInput.value = new Date().toISOString().split('T')[0];
            }
            
            // Set appropriate subspecialty based on condition
            const subspecialtyMap = {
                "Flashes & Floaters": "supervisedMacular",
                "Sudden Vision Loss": "supervisedGeneral",
                "Red Eye": "supervisedGeneral",
                "Raised IOP": "supervisedGlaucoma",
                "Eyelid Problems": "supervisedAdnexal",
                "Watery Eyes": "supervisedAdnexal",
                "Pediatric Eye Problems": "supervisedPaed",
                "Diplopia": "supervisedSquint",
                "Headaches with Visual Symptoms": "supervisedGeneral",
                "Corneal Problems": "supervisedExternal"
            };
            
            const subspecialtyCheckbox = document.getElementsByName(subspecialtyMap[selectedCondition])[0];
            if (subspecialtyCheckbox) {
                subspecialtyCheckbox.checked = true;
            }
        }

        // Function to toggle GOS18 form
        function toggleGOS18Form() {
            const container = document.getElementById('gos18-form-container');
            container.classList.toggle('hidden');
            
            // Populate the form when opened
            if (!container.classList.contains('hidden')) {
                populateGOS18Form();
            }
        }

        // Function to hide GOS18 form
        function hideGOS18Form() {
            const container = document.getElementById('gos18-form-container');
            container.classList.add('hidden');
        }

        // Function to download GOS18 as PDF
        async function downloadGOS18() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            
            // Get form data
            const formData = new FormData(document.getElementById('gos18-form'));
            
            // Add title
            pdf.setFontSize(16);
            pdf.text('GOS 18 - Referral/Notification', 20, 20);
            
            // Add form content
            let yPosition = 40;
            const lineHeight = 10;
            
            // Iterate through form data
            for (let [key, value] of formData.entries()) {
                if (value && value !== '') {
                    pdf.setFontSize(10);
                    pdf.text(`${key}: ${value}`, 20, yPosition);
                    yPosition += lineHeight;
                    
                    if (yPosition > 280) {
                        pdf.addPage();
                        yPosition = 20;
                    }
                }
            }
            
            // Save the PDF
            pdf.save('GOS18_Referral.pdf');
        }

        // Function to copy GOS18 data
        function copyGOS18() {
            const formData = new FormData(document.getElementById('gos18-form'));
            let textContent = 'GOS 18 - Referral/Notification\n\n';
            
            for (let [key, value] of formData.entries()) {
                if (value && value !== '') {
                    textContent += `${key}: ${value}\n`;
                }
            }
            
            navigator.clipboard.writeText(textContent).then(() => {
                const button = event.target.closest('button');
                button.textContent = 'Copied!';
                button.classList.add('copy-success');
                
                setTimeout(() => {
                    button.innerHTML = `
                        <svg class="icon" viewBox="0 0 24 24" style="display: inline-block; margin-right: 0.5rem;">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                        Copy GOS18
                    `;
                    button.classList.remove('copy-success');
                }, 2000);
            });
        }

        // Function to start over
        function startOver() {
            currentStep = 'welcome';
            selectedCondition = null;
            responses = {};
            currentQuestionIndex = 0;
            assessmentPath = [];
            recommendation = null;
            decisionPath = [];
            questionHistory = [];
            
            document.getElementById('welcome-screen').classList.remove('hidden');
            document.getElementById('assessment-screen').classList.add('hidden');
            document.getElementById('results-screen').classList.add('hidden');
            
            window.scrollTo(0, 0);
        }

        // Function to go to previous question
        function previousQuestion() {
            if (questionHistory.length > 0) {
                currentQuestionIndex = questionHistory.pop();
                // Remove the last response
                const questions = clinicalSchema[selectedCondition].questions;
                const questionId = questions[currentQuestionIndex].id;
                delete responses[questionId];
                
                displayQuestion();
            }
        }

        // Function to copy assessment results
        function copyAssessmentResults() {
            let resultText = `EyeSpecialist.ai Assessment Results\n\n`;
            resultText += `Condition: ${selectedCondition}\n`;
            resultText += `Urgency: ${recommendation.urgency.toUpperCase()}\n`;
            resultText += `Diagnosis: ${recommendation.condition}\n`;
            resultText += `Severity Score: ${recommendation.severityScore || 'N/A'}\n\n`;
            resultText += `Clinical Reasoning:\n${recommendation.reasoning}\n\n`;
            resultText += `Management:\n`;
            recommendation.management.forEach(step => {
                resultText += `â€¢ ${step}\n`;
            });
            resultText += `\nReferral Timeframe: ${recommendation.referralTimeframe}\n`;
            
            navigator.clipboard.writeText(resultText).then(() => {
                const button = document.getElementById('copy-button');
                button.textContent = 'Copied!';
                button.classList.add('copy-success');
                
                setTimeout(() => {
                    button.textContent = 'Copy Assessment';
                    button.classList.remove('copy-success');
                }, 2000);
            });
        }

        // Function to display conditions
        function displayConditions() {
            const conditionGrid = document.getElementById('condition-grid');
            conditionGrid.innerHTML = '';
            
            Object.entries(clinicalSchema).forEach(([name, schema]) => {
                const card = document.createElement('button');
                card.className = 'condition-card';
                card.onclick = () => selectCondition(name);
                
                card.innerHTML = `
                    <div class="condition-header">
                        <h3 class="condition-title">${name}</h3>
                        <svg class="icon" viewBox="0 0 24 24" style="opacity: 0.5;">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </div>
                    <p class="condition-description">${schema.description}</p>
                    <p class="condition-pathways">Pathways: ${schema.pathways.join(', ')}</p>
                `;
                
                conditionGrid.appendChild(card);
            });
        }

        // Function to select condition
        function selectCondition(condition) {
            selectedCondition = condition;
            currentQuestionIndex = 0;
            responses = {};
            assessmentPath = [];
            questionHistory = [];
            
            document.getElementById('welcome-screen').classList.add('hidden');
            document.getElementById('assessment-screen').classList.remove('hidden');
            document.getElementById('assessment-subtitle').textContent = `${condition} Assessment`;
            
            displayRedFlags();
            displayQuestion();
        }

        // Function to display red flags
        function displayRedFlags() {
            const redFlagsBox = document.getElementById('red-flags-box');
            const redFlagsList = document.getElementById('red-flags-list');
            const schema = clinicalSchema[selectedCondition];
            
            if (schema.redFlags && schema.redFlags.length > 0) {
                redFlagsBox.classList.remove('hidden');
                redFlagsList.innerHTML = '';
                
                schema.redFlags.forEach(flag => {
                    const li = document.createElement('li');
                    li.className = 'red-flag-item';
                    li.innerHTML = `
                        <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px; flex-shrink: 0;">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="12"></line>
                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                        </svg>
                        ${flag}
                    `;
                    redFlagsList.appendChild(li);
                });
            } else {
                redFlagsBox.classList.add('hidden');
            }
        }

        // Function to display question
        function displayQuestion() {
            const schema = clinicalSchema[selectedCondition];
            const questions = schema.questions;
            
            if (currentQuestionIndex >= questions.length) {
                generateRecommendation();
                return;
            }
            
            const question = questions[currentQuestionIndex];
            
            // Update progress
            const progressText = `Question ${currentQuestionIndex + 1} of ${questions.length}`;
            const progressPercent = Math.round((currentQuestionIndex / questions.length) * 100);
            
            document.getElementById('progress-text').textContent = progressText;
            document.getElementById('progress-percent').textContent = `${progressPercent}% Complete`;
            document.getElementById('progress-fill').style.width = `${progressPercent}%`;
            
            // Display question
            document.getElementById('question-title').textContent = question.text;
            
            // Show/hide subtitle
            const subtitleElement = document.getElementById('question-subtitle');
            if (question.subtitle) {
                subtitleElement.textContent = question.subtitle;
                subtitleElement.classList.remove('hidden');
            } else {
                subtitleElement.classList.add('hidden');
            }
            
            // Display options
            const optionsContainer = document.getElementById('question-options');
            optionsContainer.innerHTML = '';
            
            const optionsDiv = document.createElement('div');
            optionsDiv.className = 'options-container';
            
            question.options.forEach(option => {
                const button = document.createElement('button');
                button.className = 'option-button';
                button.textContent = option;
                button.onclick = () => selectAnswer(option);
                optionsDiv.appendChild(button);
            });
            
            optionsContainer.appendChild(optionsDiv);
            
            // Display clinical note
            const clinicalNoteElement = document.getElementById('clinical-note');
            if (question.clinicalNote) {
                clinicalNoteElement.textContent = question.clinicalNote;
                clinicalNoteElement.classList.remove('hidden');
            } else {
                clinicalNoteElement.classList.add('hidden');
            }
            
            // Update navigation
            const backButton = document.getElementById('back-button');
            backButton.disabled = questionHistory.length === 0;
        }

        // Function to select answer
        function selectAnswer(answer) {
            const schema = clinicalSchema[selectedCondition];
            const questions = schema.questions;
            const question = questions[currentQuestionIndex];
            
            // Store response
            responses[question.id] = answer;
            assessmentPath.push({
                question: question.text,
                answer: answer
            });
            
            // Store current index in history before moving forward
            questionHistory.push(currentQuestionIndex);
            
            // Move to next question
            currentQuestionIndex++;
            displayQuestion();
        }

        // Function to generate recommendation
        function generateRecommendation() {
            const schema = clinicalSchema[selectedCondition];
            
            // Calculate severity score
            const severityScore = calculateSeverityScore(selectedCondition, responses);
            const scoreBasedUrgency = calculateUrgencyByScore(severityScore, selectedCondition);
            
            // Check triage logic
            let matchFound = false;
            let matchType = '';
            
            // Check emergency criteria
            for (const rule of schema.triageLogic.emergency || []) {
                if (checkCriteria(rule.criteria, responses)) {
                    recommendation = {
                        urgency: 'emergency',
                        condition: rule.condition,
                        management: rule.management,
                        reasoning: `Emergency criteria met: ${rule.criteria.join(', ')}. ${rule.condition}. Severity score: ${severityScore}.`,
                        referralTimeframe: 'Immediate/Same-day',
                        severityScore: severityScore
                    };
                    matchFound = true;
                    matchType = 'Emergency rule';
                    break;
                }
            }
            
            // Check urgent criteria
            if (!matchFound) {
                for (const rule of schema.triageLogic.urgent || []) {
                    if (checkCriteria(rule.criteria, responses)) {
                        recommendation = {
                            urgency: 'urgent',
                            condition: rule.condition,
                            management: rule.management,
                            reasoning: `Urgent criteria met: ${rule.criteria.join(', ')}. ${rule.condition}. Severity score: ${severityScore}.`,
                            referralTimeframe: 'Within 24-48 hours',
                            severityScore: severityScore
                        };
                        matchFound = true;
                        matchType = 'Urgent rule';
                        break;
                    }
                }
            }
            
            // Check semi-urgent criteria
            if (!matchFound && schema.semiUrgent) {
                for (const rule of schema.semiUrgent) {
                    if (checkCriteria(rule.criteria, responses)) {
                        recommendation = {
                            urgency: 'semi-urgent',
                            condition: rule.condition,
                            management: rule.management,
                            reasoning: `Semi-urgent criteria met: ${rule.criteria.join(', ')}. ${rule.condition}. Severity score: ${severityScore}.`,
                            referralTimeframe: 'Within 48-72 hours',
                            severityScore: severityScore
                        };
                        matchFound = true;
                        matchType = 'Semi-urgent rule';
                        break;
                    }
                }
            }
            
            // Check routine criteria
            if (!matchFound) {
                for (const rule of schema.triageLogic.routine || []) {
                    if (checkCriteria(rule.criteria, responses)) {
                        recommendation = {
                            urgency: 'routine',
                            condition: rule.condition,
                            management: rule.management,
                            reasoning: `Routine criteria met: ${rule.criteria.join(', ')}. ${rule.condition}. Severity score: ${severityScore}.`,
                            referralTimeframe: 'Routine (within 4-12 weeks)',
                            severityScore: severityScore
                        };
                        matchFound = true;
                        matchType = 'Routine rule';
                        break;
                    }
                }
            }
            
            // Apply enhanced default rules if no specific match
            if (!matchFound) {
                const defaultMatch = applyEnhancedDefaultRules(schema, responses, severityScore, scoreBasedUrgency);
                if (defaultMatch) {
                    recommendation = defaultMatch;
                    matchFound = true;
                    matchType = 'Enhanced default rule';
                    
                    // Show enhanced indicator
                    document.getElementById('enhanced-indicator').style.display = 'flex';
                }
            }
            
            // Final fallback - severity score based
            if (!matchFound) {
                recommendation = {
                    urgency: scoreBasedUrgency,
                    condition: `${selectedCondition} requiring assessment`,
                    management: getDefaultManagement(scoreBasedUrgency, selectedCondition),
                    reasoning: `Based on severity score of ${severityScore}. Clinical assessment recommended.`,
                    referralTimeframe: getTimeframeForUrgency(scoreBasedUrgency),
                    severityScore: severityScore
                };
                matchType = 'Severity score fallback';
            }
            
            // Update debug info
            document.getElementById('debug-urgency').textContent = recommendation.urgency;
            document.getElementById('debug-score').textContent = severityScore;
            document.getElementById('debug-match').textContent = matchType;
            
            displayResults();
        }

        // Function to check criteria
        function checkCriteria(criteria, responses) {
            return criteria.every(criterion => {
                const [questionId, expectedAnswer] = criterion.split(':');
                return responses[questionId] === expectedAnswer;
            });
        }

        // Function to get default management
        function getDefaultManagement(urgency, condition) {
            const defaultManagement = {
                emergency: [
                    "Immediate ophthalmology assessment required",
                    "Document all findings",
                    "Do not delay referral",
                    "Consider admission if systemic symptoms"
                ],
                urgent: [
                    "Urgent ophthalmology assessment within 24-48 hours",
                    "Document visual acuity",
                    "Safety-net advice crucial",
                    "Consider starting treatment if clear diagnosis"
                ],
                routine: [
                    "Routine ophthalmology referral",
                    "Conservative management initially",
                    "Review if symptoms worsen",
                    "Patient education important"
                ]
            };
            
            return defaultManagement[urgency] || defaultManagement.urgent;
        }

        // Function to display results
        function displayResults() {
            document.getElementById('assessment-screen').classList.add('hidden');
            document.getElementById('results-screen').classList.remove('hidden');
            
            // Set urgency icon and color
            const urgencyIcon = document.getElementById('urgency-icon');
            const iconColors = {
                emergency: '#dc2626',
                urgent: '#f59e0b',
                'semi-urgent': '#3b82f6',
                routine: '#10b981'
            };
            
            urgencyIcon.style.backgroundColor = iconColors[recommendation.urgency] || '#f59e0b';
            urgencyIcon.innerHTML = `
                <svg class="icon" viewBox="0 0 24 24">
                    ${recommendation.urgency === 'emergency' ? 
                        '<path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line>' :
                        '<circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line>'}
                </svg>
            `;
            
            // Set recommendation text
            document.getElementById('recommendation-title').textContent = 
                `${recommendation.urgency.charAt(0).toUpperCase() + recommendation.urgency.slice(1)} Referral`;
            document.getElementById('recommendation-subtitle').textContent = recommendation.condition;
            document.getElementById('reasoning-text').textContent = recommendation.reasoning;
            
            // Set severity score
            const severityScore = recommendation.severityScore || 0;
            document.getElementById('severity-score').textContent = `Clinical Severity Score: ${severityScore}`;
            document.getElementById('severity-fill').style.width = `${Math.min(severityScore * 5, 100)}%`;
            
            // Set next steps
            document.getElementById('next-steps-text').textContent = 
                `${recommendation.urgency.toUpperCase()} ophthalmology referral required. Timeframe: ${recommendation.referralTimeframe}`;
            
            // Set management steps
            const immediateManagementList = document.getElementById('immediate-management');
            immediateManagementList.innerHTML = '';
            
            const managementSteps = immediateManagementConfig[selectedCondition]?.[recommendation.urgency] || 
                                    recommendation.management;
            
            managementSteps.forEach(step => {
                const li = document.createElement('li');
                li.className = 'management-item';
                li.innerHTML = `
                    <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px; flex-shrink: 0;">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    ${step}
                `;
                immediateManagementList.appendChild(li);
            });
            
            // Set medications
            const medicationsList = document.getElementById('medications-list');
            const medicationsBox = document.getElementById('medications-box');
            medicationsList.innerHTML = '';
            
            const medicationProtocol = medicationProtocols[selectedCondition]?.[recommendation.urgency];
            if (medicationProtocol && medicationProtocol.medications.length > 0) {
                medicationsBox.style.display = 'block';
                medicationProtocol.medications.forEach(med => {
                    const li = document.createElement('li');
                    li.className = 'management-item';
                    li.innerHTML = `
                        <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px; flex-shrink: 0;">
                            <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.11 1.13C11.29 3.5 10.04 3 8.28 3a5.5 5.5 0 0 0 0 11C8.28 14 12 21 12 21s3.72-7 3.72-7z"></path>
                        </svg>
                        ${med}
                    `;
                    medicationsList.appendChild(li);
                });
                
                // Add notes if present
                if (medicationProtocol.notes) {
                    const noteItem = document.createElement('li');
                    noteItem.className = 'management-item';
                    noteItem.style.fontStyle = 'italic';
                    noteItem.style.marginTop = '0.5rem';
                    noteItem.innerHTML = `
                        <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px; flex-shrink: 0;">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="16" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12.01" y2="8"></line>
                        </svg>
                        ${medicationProtocol.notes}
                    `;
                    medicationsList.appendChild(noteItem);
                }
            } else {
                medicationsBox.style.display = 'none';
            }
            
            // Set documentation requirements
            const formsList = document.getElementById('forms-list');
            formsList.innerHTML = '';
            
            const docRequirements = documentationRequirements[selectedCondition];
            if (docRequirements) {
                // Add general forms
                docRequirements.forms.forEach(form => {
                    const li = document.createElement('li');
                    li.className = 'forms-item';
                    li.innerHTML = `
                        <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px; flex-shrink: 0;">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                        </svg>
                        ${form}
                    `;
                    formsList.appendChild(li);
                });
                
                // Add urgency-specific requirements
                if (docRequirements.specific[recommendation.urgency]) {
                    docRequirements.specific[recommendation.urgency].forEach(req => {
                        const li = document.createElement('li');
                        li.className = 'forms-item';
                        li.innerHTML = `
                            <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px; flex-shrink: 0;">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                            </svg>
                            ${req}
                        `;
                        formsList.appendChild(li);
                    });
                }
            }
            
            // Always add GOS18 form
            const gos18Item = document.createElement('li');
            gos18Item.className = 'forms-item';
            gos18Item.innerHTML = `
                <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px; flex-shrink: 0;">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                </svg>
                GOS18 referral form (click button below to generate)
            `;
            formsList.appendChild(gos18Item);
            
            // Set safety-netting advice
            const safetyList = document.getElementById('safety-list');
            safetyList.innerHTML = '';
            
            const safetyAdvice = safetyNettingConfig[selectedCondition]?.[recommendation.urgency] || [
                "Return immediately if symptoms worsen",
                "Seek urgent care if new symptoms develop",
                "Attend all follow-up appointments",
                "Contact emergency services if concerned"
            ];
            
            safetyAdvice.forEach(advice => {
                const li = document.createElement('li');
                li.className = 'safety-item';
                li.innerHTML = `
                    <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px; flex-shrink: 0;">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                    </svg>
                    ${advice}
                `;
                safetyList.appendChild(li);
            });
            
            window.scrollTo(0, 0);
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            displayConditions();
        });
    </script>
</body>
</html>
